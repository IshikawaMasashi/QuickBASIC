!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.QuickBASIC=e():t.QuickBASIC=e()}(window,(function(){return function(t){var e={};function n(r){if(e[r])return e[r].exports;var i=e[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}return n.m=t,n.c=e,n.d=function(t,e,r){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var i in t)n.d(r,i,function(e){return t[e]}.bind(null,i));return r},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=20)}([function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var i=n(2),s=r(n(2)),o=n(12),a=n(31),u=n(32),c=n(33),p=n(34),h=n(35),l=n(36),f=n(37),d=n(38),m=n(39),y=n(40),v=n(41),g=n(42),b=n(43),S=n(13),x=n(44),T=n(14),w=n(45),_=n(46),N=n(47),E=n(48),R=n(49),I=n(50),A=n(51),k=n(52),O=n(53),P=n(54),L=n(55),C=n(56),M=n(7),D=n(57),F=n(58),j=n(59),G=n(60),U=n(61),B=n(62),H=n(63),V=n(64),Y=n(65),W=n(72),X=n(17),K=n(81),z=n(19),$=n(18),Z=n(82);function J(t){return"INTEGER"==t.name||"SINGLE"==t.name||"DOUBLE"==t.name}function Q(t){return t instanceof z.ArrayType}function q(t,n){var r=new G.AstProgram(n,new L.AstSubroutine(n,"_main",[],t[0],!1));return e.dbg.printf("Program successfully parsed. %d statements.\n",r.subs[0].statements.length),r}function tt(t,e){return new y.AstConstantExpr(e,parseFloat(t[0]))}function et(t,e){return new y.AstConstantExpr(e,t[0].substr(1,t[0].length-2))}function nt(t,e){return new h.AstBinaryOp(e,t[0],t[1],t[2])}function rt(t,e){return t[1]}function it(t){return t[1]}function st(t){return t[0]}function ot(t){return t[0].push(t[1]),t[0]}function at(t){return t[1].unshift(t[0]),t[1]}function ut(t){return[]}e.sprintf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];1==t.length&&t[0]instanceof Array&&(t=t[0]);for(var n="",r=t[0].split(/%[^%]/),i=0;i<r.length;i++)n+=r[i],void 0!==t[i+1]&&(n+=t[i+1]);return n},e.DeriveTypeNameFromVariable=function(t){switch(t[t.length-1]){case"$":return"STRING";case"%":return"INTEGER";case"&":return"LONG";case"#":return"DOUBLE";case"!":return"SINGLE"}return null},e.IsNumericType=J,e.IsStringType=function(t){return"STRING"==t.name},e.IsArrayType=Q,e.IsUserType=function(t){return t instanceof X.UserType},e.IsNullType=function(t){return t instanceof $.NullType},e.AreTypesCompatible=function(t,e){return t.name==e.name||J(t)&&J(e)||Q(t)&&Q(e)&&("ANY"==t.elementType.name||"ANY"==e.elementType.name)||!Q(t)&&!Q(e)&&("ANY"==t.name||"ANY"==e.name)},Array.prototype.accept=function(t){for(var e=0;e<this.length;e++)this[e]&&this[e].accept(t)};var ct=function(){function t(n,r){if(this.testMode=r,this.errors=[],this.callMap=new Map,this.breakpoints=[],this.toByteCodeLineNumber=new Map,this.toSourceCodeLineNumber=new Map,this.fromSourceCodeLineNumberToProgramCounter=new Map,void 0===t.parser){var h=new i.RuleParser(e.dbg);h.addRule("start: program"),h.addToken("AND","AND"),h.addToken("AS","AS"),h.addToken("CASE","CASE"),h.addToken("CONST","CONST"),h.addToken("DATA","DATA"),h.addToken("DECLARE","DECLARE"),h.addToken("DEF","DEF"),h.addToken("DEFINT","DEFINT"),h.addToken("DIM","DIM"),h.addToken("DO","DO"),h.addToken("ELSE","ELSE"),h.addToken("END","END"),h.addToken("EXIT","EXIT"),h.addToken("FOR","FOR"),h.addToken("FUNCTION","FUNCTION"),h.addToken("GOSUB","GOSUB"),h.addToken("GOTO","GOTO"),h.addToken("IF","IF"),h.addToken("INPUT","INPUT"),h.addToken("LINE","LINE"),h.addToken("LOOP","LOOP"),h.addToken("MOD","MOD"),h.addToken("NEXT","NEXT"),h.addToken("NOT","NOT"),h.addToken("OR","OR"),h.addToken("POKE","POKE"),h.addToken("PRINT","PRINT"),h.addToken("RESTORE","RESTORE"),h.addToken("RETURN","RETURN"),h.addToken("SEG","SEG"),h.addToken("SELECT","SELECT"),h.addToken("SHARED","SHARED"),h.addToken("STATIC","STATIC"),h.addToken("STEP","STEP"),h.addToken("SUB","SUB"),h.addToken("TAB","TAB"),h.addToken("THEN","THEN"),h.addToken("TO","TO"),h.addToken("TYPE","TYPE"),h.addToken("UNTIL","UNTIL"),h.addToken("USING","USING"),h.addToken("VIEW","VIEW"),h.addToken("WEND","WEND"),h.addToken("WHILE","WHILE"),h.addToken("OPEN","OPEN"),h.addToken("OUTPUT","OUTPUT"),h.addToken("minus","\\-"),h.addToken("endl","\\n"),h.addToken("comment","'.*$"),h.addToken("hexconstant","\\&H\\d+"),h.addToken("floatconstant","\\d*\\.\\d+"),h.addToken("intconstant","\\d+"),h.addToken("stringconstant",'"[^"]*"'),h.addToken("label","^([a-zA-Z][a-zA-Z0-9_]*:|\\d+)"),h.addToken("identifier","[a-zA-Z_][a-zA-Z0-9_]*(\\$|%|#|&|!)?"),h.addToken("filenumber","\\#\\d+"),h.addRule("program: statements",q),h.addRule("statements: statement*"),h.addRule("statement: label istatement separator",(function(t,e){var n=t[0];return":"==n.substr(-1)&&(n=n.substr(0,n.length-1)),[new x.AstLabel(e,n),t[1]]})),h.addRule("statement: label",(function(t,e){var n=t[0];return":"==n.substr(-1)&&(n=n.substr(0,n.length-1)),new x.AstLabel(e,n)})),h.addRule("statement: istatement ? separator"),h.addRule("istatement: CONST identifier '=' expr",(function(t,e){return new d.AstConstStatement(e,t[1],t[3])})),h.addRule("istatement: DECLARE FUNCTION identifier ArgList",(function(t,e){return new o.AstDeclareFunction(e,t[2],t[3],!0)})),h.addRule("istatement: DECLARE SUB identifier ArgList",(function(t,e){return new o.AstDeclareFunction(e,t[2],t[3],!1)})),h.addRule("istatement: SUB identifier ArgList STATIC? statements END SUB",(function(t,e){return new L.AstSubroutine(e,t[1],t[2],t[4],!1,null!==t[3])})),h.addRule("istatement: FUNCTION identifier ArgList statements END FUNCTION",(function(t,e){return new L.AstSubroutine(e,t[1],t[2],t[3],!0)})),h.addRule("istatement: DEF SEG ('=' expr)?",(function(t,e){return new c.AstNullStatement(e)})),h.addRule("istatement: DEF identifier ArgList '=' expr",(function(t,e){return new c.AstNullStatement(e)})),h.addRule("istatement: DEFINT identifier minus identifier",(function(t,e){return new U.AstDefTypeStatement(e,"INTEGER")})),h.addRule("istatement: VIEW PRINT",(function(t,e){return new c.AstNullStatement(e)})),h.addRule("istatement: DIM DimList",it),h.addRule("istatement: DIM SHARED DimList",(function(t,e){for(var n=0;n<t[2].length;n++)t[2][n].shared=!0;return t[2]})),h.addRule("istatement: WHILE expr separator statements WEND",(function(t,e){return new D.AstWhileLoop(e,t[1],t[3])})),h.addRule("istatement: DO separator statements LOOP",(function(t,e){return new T.AstDoStatement(e,t[2],null,T.AstDoStatement.INFINITE)})),h.addRule("istatement: DO separator statements LOOP WHILE expr",(function(t,e){return new T.AstDoStatement(e,t[2],t[5],T.AstDoStatement.WHILE_AT_END)})),h.addRule("istatement: DO separator statements LOOP UNTIL expr",(function(t,e){return new T.AstDoStatement(e,t[2],t[5],T.AstDoStatement.UNTIL)})),h.addRule("istatement: DO WHILE expr separator statements LOOP",(function(t,e){return new D.AstWhileLoop(e,t[2],t[4])})),h.addRule("istatement: FOR identifier '=' expr TO expr",(function(t,e){return new E.AstForLoop(e,t[1],t[3],t[5],new y.AstConstantExpr(e,1))})),h.addRule("istatement: FOR identifier '=' expr TO expr STEP expr",(function(t,e){return new E.AstForLoop(e,t[1],t[3],t[5],t[7])})),h.addRule("istatement: NEXT identifiers?",(function(t,e){return null===t[1]&&(t[1]=[]),new _.AstNextStatement(e,t[1])})),h.addRule("istatement: EXIT (FOR|DO)",(function(t,e){return new m.AstExitStatement(e,t[1])})),h.addRule("identifiers: MoreIdentifiers* identifier",ot),h.addRule("MoreIdentifiers: identifier ','",st),h.addRule("istatement: END",(function(t,e){return new u.AstEndStatement(e)})),h.addRule("istatement: GOSUB identifier",(function(t,e){return new v.AstGosubStatement(e,t[1])})),h.addRule("istatement: GOTO identifier",(function(t,e){return new g.AstGotoStatement(e,t[1])})),h.addRule("istatement: IF expr THEN istatement",(function(t,e){return new R.AstIfStatement(e,t[1],t[3],null)})),h.addRule("istatement: IF expr THEN separator statements ElseClause END IF",(function(t,e){return new R.AstIfStatement(e,t[1],t[4],t[5])})),h.addRule("ElseClause: ELSE IF expr THEN separator statements ElseClause",(function(t,e){return new R.AstIfStatement(e,t[2],t[5],t[6])})),h.addRule("ElseClause: ELSE statements",it),h.addRule("ElseClause:",(function(t,e){return new c.AstNullStatement(e)})),h.addRule("istatement: SELECT CASE expr separator case* END SELECT",(function(t,e){return new P.AstSelectStatement(e,t[2],t[4])})),h.addRule("case: CASE exprList separator statements",(function(t,e){return new f.AstCaseStatement(e,t[1],t[3])})),h.addRule("case: CASE ELSE separator statements",(function(t,e){return new f.AstCaseStatement(e,[],t[3])})),h.addRule("exprList: moreExpr* expr",ot),h.addRule("moreExpr: expr ','",st),h.addRule("istatement: INPUT constant? (';'|',') identifiers",(function(t,e){return new b.AstInputStatement(e,t[1],";"==t[2],t[3])})),h.addRule("istatement: LINE? INPUT filenumber (';'|',') Reference",(function(t,e){return new b.AstInputStatement(e,t[2],";"==t[3],t[4],!!t[0])})),h.addRule("istatement: PRINT filenumber (';'|',') PrintItems",(function(t,e){return new A.AstPrintStatement(e,t[3],t[1])})),h.addRule("istatement: LINE? INPUT identifiers",(function(t,e){return new b.AstInputStatement(e,null,!1,t[2])})),h.addRule("istatement: POKE expr ',' expr",(function(t,e){return new c.AstNullStatement(e)})),h.addRule("istatement: OPEN expr FOR ('INPUT'|'OUTPUT') AS filenumber",(function(t,e){return new Z.AstOpenStatement(e,t[1],t[3],t[5])})),h.addRule("istatement: PRINT",(function(t,e){return new A.AstPrintStatement(e,[])})),h.addRule("istatement: PRINT PrintItems",(function(t,e){return new A.AstPrintStatement(e,t[1])})),h.addRule("istatement: PRINT USING [expr,';'] (';'|',')?",(function(t,e){return new k.AstPrintUsingStatement(e,t[2],t[3])})),h.addRule("PrintItems: PrintItem",(function(t,e){return t})),h.addRule("PrintItems: MorePrintItems* PrintItem (';'|',')?",(function(t,e){return t[1].terminator=t[2],t[0].push(t[1]),t[0]})),h.addRule("MorePrintItems: PrintItem (';'|',')",(function(t,e){return t[0].terminator=t[1],t[0]})),h.addRule("PrintItem: expr",(function(t,e){return new S.AstPrintItem(e,S.AstPrintItem.EXPR,t[0],null)})),h.addRule("PrintItem: TAB '\\(' expr '\\)'",(function(t,e){return new S.AstPrintItem(e,S.AstPrintItem.TAB,t[2],null)})),h.addRule("PrintItem:",(function(t,e){return new S.AstPrintItem(e,S.AstPrintItem.EXPR,null,null)})),h.addRule("istatement: RESTORE identifier?",(function(t,e){return new B.AstRestoreStatement(e,t[1])})),h.addRule("istatement: RETURN",(function(t,e){return new O.AstReturnStatement(e)})),h.addRule("istatement: DATA [DataConstant,',']",(function(t,e){return new N.AstDataStatement(e,t[1])})),h.addRule("DataConstant: identifier",(function(t,e){return new y.AstConstantExpr(e,t[0])})),h.addRule("DataConstant: constant"),h.addRule("DataConstant:",(function(t,e){return new y.AstConstantExpr(e,null)})),h.addRule("istatement: TYPE identifier separator TypeMembers END TYPE",(function(t,e){return new H.AstUserType(e,t[1],t[3])})),h.addRule("istatement: AssignStatement"),h.addRule("AssignStatement: ReferenceList '=' expr2",(function(t,e){return new p.AstAssignStatement(e,t[0],t[2])})),h.addRule("istatement: identifier Parameters",(function(t,e){return new l.AstCallStatement(e,t[0],t[1])})),h.addRule("Parameters: ",ut),h.addRule("Parameters: '\\(' ParameterList '\\)'",it),h.addRule("Parameters: ParameterList"),h.addRule("ParameterList: [Parameter,',']"),h.addRule("Parameter: expr"),h.addRule("Parameter:",(function(t,e){return new y.AstConstantExpr(e,null)})),h.addRule("Parameter: filenumber",(function(t,e){return new y.AstConstantExpr(e,t[0])})),h.addRule("DimList: Dim MoreDims*",at),h.addRule("MoreDims: ',' Dim",it),h.addRule("Dim: identifier AsType?",(function(t,e){return new j.AstDimStatement(e,t[0],[],t[1])})),h.addRule("Dim: identifier '\\(' RangeList '\\)' AsType?",(function(t,e){return new j.AstDimStatement(e,t[0],t[2],t[4])})),h.addRule("AsType: AS identifier",it),h.addRule("RangeList:",(function(t,e){return null})),h.addRule("RangeList: Range MoreRanges*",at),h.addRule("MoreRanges: ',' Range",it),h.addRule("Range: expr EndRange?",(function(t,e){return t[1]?new F.AstRange(e,t[0],t[1]):new F.AstRange(e,new y.AstConstantExpr(e,0),t[0])})),h.addRule("EndRange: TO expr",it),h.addRule("TypeMembers: TypeMember*"),h.addRule("TypeMember: identifier AS identifier separator",(function(t,e){return new w.AstTypeMember(e,t[0],t[2])})),h.addRule("ArgList:",(function(t,e){return[]})),h.addRule("ArgList: '\\(' [ Argument , ',' ] '\\)'",(function(t,e){return t[1]})),h.addRule("Argument: identifier OptParen? AS identifier",(function(t,e){return new a.AstArgument(e,t[0],t[3],null!==t[1])})),h.addRule("Argument: identifier OptParen?",(function(t,e){return new a.AstArgument(e,t[0],null,null!==t[1])})),h.addRule("OptParen: '\\(' '\\)'"),h.addRule("expr: expr2"),h.addRule("expr2: expr2 OR expr3",nt),h.addRule("expr2: expr3"),h.addRule("expr3: expr3 AND expr4",nt),h.addRule("expr3: expr4"),h.addRule("expr4: expr4 '=' expr5",nt),h.addRule("expr4: expr4 '<>' expr5",nt),h.addRule("expr4: expr4 '>' expr5",nt),h.addRule("expr4: expr4 '<' expr5",nt),h.addRule("expr4: expr4 '<=' expr5",nt),h.addRule("expr4: expr4 '>=' expr5",nt),h.addRule("expr4: expr5"),h.addRule("expr5: expr5 MOD expr6",nt),h.addRule("expr5: expr6"),h.addRule("expr6: expr6 '\\+' expr7",nt),h.addRule("expr6: expr6 '\\-' expr7",nt),h.addRule("expr6: expr7"),h.addRule("expr7: expr7 '\\*' expr8",nt),h.addRule("expr7: expr7 '\\/' expr8",nt),h.addRule("expr7: expr7 '\\^' expr8",nt),h.addRule("expr7: expr8"),h.addRule("expr8: '\\(' expr '\\)'",rt),h.addRule("expr8: NOT expr9",(function(t,e){return new C.AstUnaryOperator(e,"NOT",t[1])})),h.addRule("expr8: '\\-' expr9",(function(t,e){return new C.AstUnaryOperator(e,"-",t[1])})),h.addRule("expr8: expr9"),h.addRule("expr9: constant"),h.addRule("expr9: expr10"),h.addRule("expr10: ReferenceList"),h.addRule("constant: hexconstant",tt),h.addRule("constant: intconstant",tt),h.addRule("constant: floatconstant",tt),h.addRule("constant: stringconstant",et),h.addRule("ReferenceList: ReferenceList '\\.' identifier",(function(t,e){return new I.AstMemberDeref(e,t[0],t[2])})),h.addRule("ReferenceList: ReferenceList '\\(' ParameterList '\\)'",(function(t,e){return new V.AstArrayDeref(e,t[0],t[2])})),h.addRule("ReferenceList: Reference"),h.addRule("Reference: identifier",(function(t,e){return new M.AstVariableReference(e,t[0])})),h.addRule("separator: endl+"),h.addRule("separator: comment endl"),h.addRule("separator: ':'"),h.buildSet.check(this.errors);for(var G=0;G<this.errors.length;G++)e.dbg.printf("%s\n",this.errors[G]);h.buildSet.finalize(),t.parser=new s.default(h.buildSet,e.dbg)}n+="\n";var X=t.parser.parse(n);if(null===X)return this.errors=t.parser.errors,void e.dbg.printf("Parse failed.\n");var K=new W.TypeChecker(this.errors);if(X.accept(K),this.errors.length>0)e.dbg.printf("There were errors.\n");else{var z=new Y.CodeGenerator;this.codeGenerator=z,X.accept(z),this.sourcecode=n,this.instructions=z.instructions,this.types=K.types,this.defaultType=K.defaultType,this.data=z.data,this.shared=z.shared,this.lineMap=z.lineMapping,this.callMap=z.callMap,this.byteCode=this.getByteCodeAsString()}}return t.prototype.setBreakpoints=function(t){var e=this,n=t.map((function(t){return e.fromSourceCodeLineNumberToProgramCounter.get(t-1)}));this.breakpoints=n},t.prototype.getBreakpoints=function(){return this.breakpoints},t.prototype.getByteCode=function(){return this.byteCode},t.prototype.getByteCodeAsString=function(){if(this.toByteCodeLineNumber.clear(),this.toSourceCodeLineNumber.clear(),this.fromSourceCodeLineNumberToProgramCounter.clear(),!this.instructions)return"";for(var t,e=this.sourcecode.split("\n"),n=[],r=0;r<this.instructions.length;r++){t=this.lineMap[r]?this.lineMap[r]:t,this.lineMap[r]&&n.push("   ' L"+(t.line+1)+" "+e[t.line]);var i=this.instructions[r].toString().replace("\n","â†µ");n.push("["+r+"] "+i),this.toByteCodeLineNumber.set(r,n.length-1),this.toSourceCodeLineNumber.set(r,t.line),this.fromSourceCodeLineNumberToProgramCounter.set(t.line,r)}return n.join("\n")},t}();e.QBasicProgram=ct,e.ScriptSrc=void 0,e.compile=function(t,n,r){var i=new ct(t);if(0===i.errors.length)return r.run(i,!1),n.canvas.click(),n.canvas.focus(),!0;r.reset(null);for(var s=0;s<i.errors.length;s++)n.print(i.errors[s]+"\n"),e.dbg.print(i.errors[s]+"\n");n.enableCursor(!0),n.canvas.click(),n.canvas.focus()},e.compile2=function(t){return new ct(t)},e.dbg=new K.DebugConsole(document.getElementById("footer"))},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){};e.Type=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(10);e.Location=r.default;var i=n(21);e.TreeNode=i.default;var s=n(11);e.default=s.EarleyParser;var o=n(23);e.RuleParser=o.RuleParser},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r={},i=function(t,e){};e.openFile=function(t,e){i(t,e)},e.setOpenFile=function(t){i=t},e.setFileStream=function(t,e){var n={buffer:t,position:{lineNumber:1,column:0}};r[e]=n},e.getFile=function(t){return r[t]},e.getLineContent=function(t,e){return r[t].buffer.getLineContent(e)},e.setLineContent=function(t,e){var n=r[t],i=n.position.lineNumber,s=n.buffer.getValue().split(/\n/);if(s.length<i)for(var o=0;o<i-s.length;++o)s.push("");s[i-1]=e;var a=s.join("\n");n.buffer.setValue(a),n.position.lineNumber++},e.setSeekPosition=function(t,e){r[t].position=e}},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var o=function(t){function e(e,n){var r=t.call(this)||this;return r.type=e,r.value=n,r}return i(e,t),e.prototype.copy=function(){return new e(this.type,this.type.copy(this.value))},e}(s(n(16)).default);e.ScalarVariable=o},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var i=r(n(10)),s=function(){function t(t,e,n,r){this.id=t,this.text=e,this.location=new i.default(n,r)}return t.prototype.toString=function(){return"Token("+this.text+")"},t}();e.Token=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=0;e.getNextStateId=function(){return r++},e.POST_NEWLINE=-1,e.PRE_NEWLINE=-2,e.DIGIT_CHAR=-3,e.ANY_CHAR=-4;var i=function(){function t(t){this.mchar=t}return t.prototype.match=function(t){return this.mchar==e.DIGIT_CHAR?t>="0"&&t<="9":this.mchar==e.ANY_CHAR?t!==e.POST_NEWLINE&&t!==e.PRE_NEWLINE&&"\n"!=t:t==this.mchar},t.prototype.toString=function(){return this.mchar==e.DIGIT_CHAR?"\\d":this.mchar},t}();e.CharMatcher=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.name=e}return t.prototype.accept=function(t){t.visitVariableReference(this)},t}();e.AstVariableReference=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(3);e.SystemFunctions={RND:{type:"SINGLE",args:["INTEGER"],minArgs:0,action:function(t){var e=1;1==t.stack.pop()&&(e=t.stack.pop()),0===e?t.stack.push(t.lastRandomNumber):t.stack.push(Math.random())}},CHR$:{type:"STRING",args:["INTEGER"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(String.fromCharCode(e))}},INKEY$:{type:"STRING",args:[],minArgs:0,action:function(t){var e=t.cons.getKeyFromBuffer(),n="";-1!=e&&(n=String.fromCharCode(e),0===e&&(n+=String.fromCharCode(t.cons.getKeyFromBuffer()))),t.stack.push(n)}},LEN:{type:"INTEGER",args:["STRING"],minArgs:1,action:function(t){t.stack.push(t.stack.pop().length)}},MID$:{type:"STRING",args:["STRING","INTEGER","INTEGER"],minArgs:2,action:function(t){var e;3==t.stack.pop()&&(e=t.stack.pop());var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r.substr(n-1,e))}},LEFT$:{type:"STRING",args:["STRING","INTEGER"],minArgs:2,action:function(t){var e=t.stack.pop(),n=t.stack.pop();t.stack.push(n.substr(0,e))}},RIGHT$:{type:"STRING",args:["STRING","INTEGER"],minArgs:2,action:function(t){var e=t.stack.pop(),n=t.stack.pop();t.stack.push(n.substr(n.length-e))}},TIMER:{type:"INTEGER",args:[],minArgs:0,action:function(t){var e=new Date,n=e.getMilliseconds()/1e3+e.getSeconds()+60*e.getMinutes()+60*e.getHours()*60;t.stack.push(n)}},PEEK:{type:"INTEGER",args:["INTEGER"],minArgs:1,action:function(t){t.stack.pop(),t.stack.push(0)}},LCASE$:{type:"STRING",args:["STRING"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(e.toLowerCase())}},UCASE$:{type:"STRING",args:["STRING"],minArgs:1,action:function(t){t.stack.push(t.stack.pop().toUpperCase())}},STR$:{type:"STRING",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(""+e)}},SPACE$:{type:"STRING",args:["INTEGER"],minArgs:1,action:function(t){for(var e=t.stack.pop(),n="",r=0;r<e;r++)n+=" ";t.stack.push(n)}},VAL:{type:"SINGLE",args:["STRING"],minArgs:1,action:function(t){t.stack.push(parseFloat(t.stack.pop()))}},INT:{type:"INTEGER",args:["SINGLE"],minArgs:1,action:function(t){t.stack.push(Math.floor(t.stack.pop()))}},ABS:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.abs(e))}},SIN:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.sin(e))}},COS:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.cos(e))}},TAN:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.tan(e))}},ASIN:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.asin(e))}},ACOS:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.acos(e))}},ATN:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.atan(e))}},SQR:{type:"SINGLE",args:["SINGLE"],minArgs:1,action:function(t){var e=t.stack.pop();t.stack.push(Math.sqrt(e))}},EOF:{type:"INTEGER",args:["STRING"],minArgs:1,action:function(t){var e=t.stack.pop(),n=r.getFile(e),i=n.buffer.getLineCount();n.position.lineNumber>i?t.stack.push(1):t.stack.push(0)}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(3),i=function(t,e){return t.split(e).length-1},s=function(t){return String(t).split(".")[0]};e.SystemSubroutines={BEEP:{action:function(t){}},CLS:{action:function(t){t.cons.cls()}},RANDOMIZE:{action:function(t){t.stack.pop()}},PLAY:{action:function(t){t.stack.pop()}},SLEEP:{action:function(t){t.stack.pop()}},SYSTEM:{action:function(t){}},print_using:{action:function(t){for(var e=t.stack.pop(),n=t.stack.pop(),r=[],o=0;o<e-1;o++)r.unshift(t.stack.pop());var a=r.shift().value,u=[];for(o=0;o<r.length;++o)"number"!=typeof r[o]?u.push(r[o].value):u.push(r[o]);var c=function(t,e){var n=[],r=0,o=0,a="";if(t.includes("^^^^")){var u=(y=e[0].toExponential()).split("e");e[0]=Number(u[0]),a="E"+u[1],t=t.replace("^^^^","")}for(var c=0;c<t.length;++c){var p=t[c],h=t[c+1];if("#"===p||"+"===p&&"#"===h){for(r=c,++c;c<t.length;++c)if("#"!==(p=t[c])){if("."===p)for(++c;c<t.length&&"#"===(p=t[c]);++c);o=c;break}for(;c<t.length&&(p=t[c],h=t[c+1],"#"===p||","===p&&"#"==h);++c);o=Math.min(c,t.length),n.push([r,o])}}for(var l=0,f=n;l<f.length;l++){var d=f[l],m=e.shift(),y=t.substring(d[0],d[1]);if(m&&y.includes(",")){var v=s(m);if((_=i(y,"#"))>parseInt(v,10).toString().length)for(c=0;c<_-parseInt(v,10).toString().length;++c)v=" "+v;else if(parseInt(v,10)>_)for(c=0;c<parseInt(v,10).toString().length-_;++c)y="#"+y;var g="",b=" ";for(c=0;c<y.length;++c){if("#"!==(p=y[c])){if(","===p){if(" "===b){g+=" ";continue}g+=","}}else{var S=v[0];g+=S,b=S,v=v.slice(1)}}var x=t.substring(d[0],d[1]);t=t.replace(x,g)}else if(m){var T=t.substring(d[0],d[1]),w=s(m),_=w.length,N="";"+"===T[0]&&(N=Number(w)>=0?"+":"-",T=T.substring(1));g="";if(_>(u=T.split("."))[0].length)g="%"+w;else{for(c=0;c<u[0].length-_;++c)g+=" ";g+=w}u.length>1&&(g+=".",g+=m.toFixed(u[1].length).split(".")[1]),g=N+g;x=t.substring(d[0],d[1]);t=t.replace(x,g)+a}}return t}(a,u);if(t.cons.print(c),","===n){for(var p=t.cons.x,h="";++p%14;)h+=" ";t.cons.print(h)}else";"!==n&&t.cons.print("\n")}},LOCATE:{args:["INTEGER","INTEGER"],action:function(t){var e=t.stack.pop().value,n=t.stack.pop().value;t.cons.locate(n,e)}},COLOR:{args:["ANY","ANY"],minArgs:1,action:function(t){var e;2==t.stack.pop()&&(e=t.stack.pop().value);var n=t.stack.pop().value;t.cons.color(n,e)}},READ:{args:["ANY","ANY"],minArgs:1,action:function(t){var e,n=t.stack.pop(),r=[];for(e=0;e<n;e++)r.unshift(t.stack.pop());for(e=0;e<n;e++)t.trace.printf("READ %s\n",t.data[t.dataPtr]),r[e].value=t.data[t.dataPtr++],null===r[e].value&&(r[e].value=r[e].type.createInstance())}},SCREEN:{action:function(t){t.stack.pop()}},INPUT:{action:function(t){var e=t.stack.pop();if("string"==typeof e){var n=e,i=t.stack.pop(),s=r.getFile(n);if(t.stack.pop())return void(i.value=s.buffer.getLineContent(s.position.lineNumber++));var o=s.buffer.getValue().split(/\n/).slice(s.position.lineNumber);return i.value=o.join("\n"),void(s.position.lineNumber+=o.length)}var a=e,u=[];t.trace.printf("Argcount=%s\n",a);for(var c=0;c<a;c++)u.unshift(t.stack.pop());t.suspend(),t.cons.input((function(e){t.resume(),u[0].value=e}))}},SWAP:{action:function(t){var e=t.stack.pop(),n=t.stack.pop(),r=e.value;e.value=n.value,n.value=r}},WIDTH:{action:function(t){t.stack.pop(),t.stack.pop()}},OPEN:{action:function(t){var e=t.stack.pop(),n=(t.stack.pop(),t.stack.pop());r.openFile(n,e)}},SEEK:{action:function(t){var e=t.stack.pop(),n=t.stack.pop(),i=t.stack.pop();r.setSeekPosition(i.value,{lineNumber:n.value,column:e.value})}}}},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.line=t,this.position=e}return t.prototype.toString=function(){return this.line+1+":"+(this.position+1)},t}();e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(22),i=n(5),s=function(){function t(t,e){this.dbg=e,this.errors=[],this.debug=!1,this.tokenizer=t.createTokenizer(e),this.EPSILON=t.EPSILON,t.computeFirst(),this.rules=t.rules,this.first=t.first}return t.prototype.getNonTerminal=function(t){return this.rules[t]},t.prototype.getRegexFromTerminal=function(t){return t.substr(1,t.length-2)},t.prototype.isTerminal=function(t){return void 0!==t&&"'"==t[0]},t.prototype.isNonTerminal=function(t){return void 0!==t&&"'"!=t[0]},t.prototype.parse=function(t){var e,n=this.dbg,i=[[new r.EarleyItem(this.rules._start[0],0,0)]],s=0,o=0;this.tokenizer.setText(t),this.errors=[];for(var a=0;;a++){var u=this.tokenizer.nextToken(s,o);if(null===u)return this.errors.push("Bad token at "+s+":"+o+"\n"),n.printf("Bad token!\n"),null;this.debug&&n.printf("Got token %s at %s\n",u,u.location),this.location=u.location,i.push([]);for(var c=0;c<i[a].length;)this.predict(i[a],c,a,u),this.complete(i,a,c,a),c++;if(this.scan(i,a,u),0===i[a].length){for(this.errors.push("Syntax error at "+this.location+": "+u),e=0;e<i[a-1].length;e++)this.errors.push("    "+i[a-1][e]+"\n");break}if(this.debug&&this.printState(i,a),s=u.location.line,o=u.location.position+u.text.length,u.id===this.tokenizer.EOF_TOKEN){a++;break}}if(this.debug&&this.printState(i,a),i[a].length)return this.evaluate(i[a][0]);for(this.errors.push("Syntax error at "+this.location),e=0;e<i[a-1].length;e++)this.errors.push("    "+i[a-1][e]+"\n");return null},t.prototype.predict=function(t,e,n,r){var i=t[e];if(this.isNonTerminal(i.rule.symbols[i.pos]))for(var s=this.getNonTerminal(i.rule.symbols[i.pos]),o=0;o<s.length;o++){var a=s[o];(0===a.symbols.length||"'"===a.symbols[0][0]||this.first[a.symbols[0]][r.id]||this.first[a.symbols[0]][this.EPSILON])&&this.addToState(t,a,0,n,void 0,void 0)}},t.prototype.complete=function(t,e,n,r){var i=t[e][n];if(i.pos==i.rule.symbols.length)for(var s=t[i.base],o=0;o<s.length;o++)s[o].rule.symbols[s[o].pos]==i.rule.name&&this.addToState(t[e],s[o].rule,s[o].pos+1,s[o].base,i,s[o])},t.prototype.scan=function(t,e,n){for(var i=t[e],s=0;s<i.length;s++)i[s].rule.symbols[i[s].pos]==n.id&&t[e+1].push(new r.EarleyItem(i[s].rule,i[s].pos+1,i[s].base,n,i[s],this.location))},t.prototype.addToState=function(t,e,n,i,s,o){for(var a=0;a<t.length;a++)if(t[a].rule===e&&t[a].pos===n&&t[a].base===i)return;t.push(new r.EarleyItem(e,n,i,s,o,this.location))},t.prototype.printState=function(t,e){var n=this.dbg;if(this.debug){var r=t[e];n.printf("State [%d]\n",e);for(var i=0;i<r.length;i++)n.printf("%s\n",r[i]);n.printf("\n")}},t.prototype.evaluate=function(t){if(!t)return null;for(var e=[],n=t,r=t.location;n;)n.token instanceof i.Token?e.unshift(n.token.text):n.token&&e.unshift(this.evaluate(n.token)),r=n.location,n=n.prev;return t.rule.action?t.rule.action(e,r):e[0]},t}();e.EarleyParser=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.name=e,this.args=n,this.isFunction=r,this.type=null,this.hasBody=!1,this.used=!1,this.type=null,this.hasBody=!1,this.used=!1}return t.prototype.accept=function(t){t.visitDeclareFunction(this)},t}();e.AstDeclareFunction=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.type=e,this.expr=n,this.terminator=r}return t.prototype.accept=function(t){t.visitPrintItem(this)},t.EXPR=0,t.TAB=1,t}();e.AstPrintItem=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.statements=e,this.expr=n,this.type=r}return t.prototype.accept=function(t){t.visitDoStatement(this)},t.INFINITE=1,t.UNTIL=2,t.WHILE_AT_END=3,t}();e.AstDoStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t){this.pc=t,this.variables={}};e.StackFrame=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){this.id="Variable-"+t.NextId++}return t.NextId=0,t}();e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(4),i=function(){function t(t,e){this.name=t,this.members=e}return t.prototype.createInstance=function(){var t={};for(var e in this.members)t[e]=new r.ScalarVariable(this.members[e],this.members[e].createInstance());return t},t.prototype.copy=function(t){var e={};for(var n in t)e[n]=t[n].copy();return e},t}();e.UserType=i},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name=":NULL",e}return i(e,t),e.prototype.createInstance=function(){return null},e.prototype.copy=function(t){return t},e}(n(1).Type);e.NullType=s},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e){var n=t.call(this)||this;return n.elementType=e,n.name="ARRAY OF "+e.name,n}return i(e,t),e}(n(1).Type);e.ArrayType=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0);e.QBasicProgram=r.QBasicProgram,e.dbg=r.dbg,e.compile2=r.compile2;var i=n(3);e.setOpenFile=i.setOpenFile,e.setFileStream=i.setFileStream;var s=n(83);e.VirtualMachine=s.VirtualMachine;var o=n(85);e._Console=o._Console},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t){this.location=t};e.default=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(5),i=0,s=function(){function t(t,e,n,r,s,o){this.rule=t,this.pos=e,this.base=n,this.token=r,this.prev=s,this.location=o,this.id=i++}return t.prototype.toString=function(){for(var t="["+this.id+"] "+this.rule.name+":",e=0;e<this.rule.symbols.length;e++)e==this.pos&&(t+=" ."),t+=" "+this.rule.symbols[e];return e==this.pos&&(t+=" ."),t+=", "+this.base,this.token instanceof r.Token?t+=", token="+this.token.text:this.token&&(t+=", rule="+this.token.rule),this.prev&&(t+=", prev="+this.prev.id),t},t}();e.EarleyItem=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(24),i=n(11),s=function(){function t(t){var e=this;this.nextRuleId=0,this.buildSet=new r.RuleSet;var n=new r.RuleSet;n.addRule("start",["rule"]),n.addRule("identifier",["'[A-Za-z0-9_]+'"]),n.addRule("terminal",["''([^'\\\\]|\\\\.)*''"]),n.addRule("expr",["or_expr"]),n.addRule("rule",["identifier","':'","expr"],(function(t){return e.buildSet.addRule(t[0],t[2],e.action),t[0]})),n.addRule("rule",["identifier","':'"],(function(t){return e.buildSet.addRule(t[0],[],e.action),t[0]})),n.addRule("or_expr",["or_expr","'\\|'","cat_expr"],(function(t){var n="_"+e.nextRuleId++;return e.buildSet.addRule(n,t[0]),e.buildSet.addRule(n,t[2]),[n]})),n.addRule("or_expr",["cat_expr"]),n.addRule("cat_expr",["cat_expr","list_expr"],(function(t){return t[0].push(t[1]),t[0]})),n.addRule("cat_expr",["list_expr"],(function(t){return[t[0]]})),n.addRule("list_expr",["kleene_expr"]),n.addRule("list_expr",["'\\['","kleene_expr","','","kleene_expr","'\\]'"],(function(t){var n="_"+e.nextRuleId++,r="_"+e.nextRuleId++;return e.buildSet.addRule(n,[r]),e.buildSet.addRule(n,[],(function(t){return[]})),e.buildSet.addRule(r,[t[1]],(function(t){return t})),e.buildSet.addRule(r,[r,t[3],t[1]],(function(t){return t[0].push(t[2]),t[0]})),n})),n.addRule("kleene_expr",["basic_expr","'[\\+\\*\\?]'"],(function(t){var n="_"+e.nextRuleId++;if("*"==t[1])e.buildSet.addRule(n,[n,t[0]],(function(t){return t[0].push(t[1]),t[0]})),e.buildSet.addRule(n,[],(function(t){return[]}));else if("?"==t[1])e.buildSet.addRule(n,[t[0]]),e.buildSet.addRule(n,[],(function(t){return null}));else if("+"==t[1]){var r="_"+e.nextRuleId++;e.buildSet.addRule(n,[r,t[0]]),e.buildSet.addRule(r,[r,t[0]]),e.buildSet.addRule(r,[])}return n})),n.addRule("kleene_expr",["basic_expr"]),n.addRule("basic_expr",["identifier"]),n.addRule("basic_expr",["'\\('","expr","'\\)'"],(function(t){var n="_"+e.nextRuleId++;return e.buildSet.addRule(n,t[1]),n})),n.addRule("basic_expr",["terminal"]),n.finalize(),this.parser=new i.EarleyParser(n,t)}return t.prototype.addToken=function(t,e){this.buildSet.addToken(t,e)},t.prototype.addRule=function(t,e){this.action=e,this.parser.parse(t)},t}();e.RuleParser=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(25),i=n(30),s=function(){function t(){this.rules={},this.terminals=[],this.terminalsAdded={},this.first={},this.eatWhiteSpace=!0,this.EOF_TOKEN="'!EOF'",this.follow={},this.EPSILON="EPSILON",this.eatWhiteSpace?this.joinExpr=" *":this.joinExpr="",this.addRule("_start",["start",this.EOF_TOKEN])}return t.prototype.toString=function(){var t="";for(var e in this.rules)for(var n=this.rules[e],r=0;r<n.length;r++)t+=n[r].toString()+"\n";return t},t.prototype.check=function(t){var e=t.length;for(var n in this.rules)for(var r=this.rules[n],i=0;i<r.length;i++)for(var s=r[i],o=0;o<s.symbols.length;o++){var a=s.symbols[o];0===a.length?t.push("Error: Rule '"+n+"' contains a zero length symbol: "+a):"'"!=a[0]&&void 0===this.rules[a]&&t.push("Error: Rule'"+n+"' contains an undefined symbol: "+a)}return t.length-e},t.prototype.optimize=function(){for(var t=1;t;)for(var e in t=0,this.rules){var n=this.rules[e];1!=n.length||"_start"==n[0].name||n[0].action||(this.replaceRule(n[0].name,n[0].symbols),t|=1)}},t.prototype.innerExpr=function(t){return t.substr(1,t.length-2)},t.prototype.replaceRule=function(t,e){for(var n in delete this.rules[t],this.rules)for(var r=this.rules[n],i=0;i<r.length;i++)for(var s=0;s<r[i].symbols.length;s++)if(r[i].symbols[s]==t){r[i].symbols.splice(s,1);for(var o=0;o<e.length;o++)r[i].symbols.splice(s+o,0,e[o]);s+=e.length-1}},t.prototype.addRule=function(t,e,n){void 0===this.rules[t]&&(this.rules[t]=[]),this.rules[t].push(new i.Rule(t,e,n));for(var r=0;r<e.length;r++)e.length>0&&"'"==e[r][0]&&!this.terminalsAdded[e[r]]&&(this.terminalsAdded[e[r]]=1,this.terminals.push(e[r]))},t.prototype.addToken=function(t,e){this.addRule(t,["'"+e+"'"])},t.prototype.computeFirst=function(){var t;for(t in this.first={},this.rules)this.first[t]={};var e=!0,n=this;function r(t,e){var r=!(e in n.first[t]);return n.first[t][e]=1,r}function i(t,e){var i=!1;for(var s in n.first[e])i=i||r(t,s);return i}for(;e;)for(t in e=!1,this.rules)for(var s=this.rules[t],o=0;o<s.length;o++){0===s[o].symbols.length&&(e=e||r(t,this.EPSILON));for(var a=0;a<s[o].symbols.length;a++){if("'"==s[o].symbols[a][0]){e=e||r(t,s[o].symbols[a]);break}if(e=e||i(t,s[o].symbols[a]),1!==this.first[s[o].symbols[a]][this.EPSILON])break}}},t.prototype.computeFollow=function(){for(var t in this.follow={},this.rules)this.follow[t]={};for(var e=!0;e;){var n;for(var r in e=!1,this.rules)for(var i=this.rules[r],s=0;s<i.length;s++)for(var o=i[s],a=0;a<o.symbols.length;a++)if("'"!==o.symbols[a][0]){var u=this.follow[o.symbols[a]];if(a==o.symbols.length-1){if("'"!=o.symbols[a][0]&&o.symbols[a]!=r)for(n in this.follow[r])n!==this.EPSILON&&(e=e||void 0===u[n],u[n]=1)}else if("'"==o.symbols[a+1][0]||o.symbols[a+1]===this.EOF_TOKEN)e=e||void 0===u[o.symbols[a+1]],u[o.symbols[a+1]]=1;else for(n in this.first[o.symbols[a+1]])n!==this.EPSILON&&(e=e||void 0===u[n],u[n]=1)}}},t.prototype.finalize=function(){this.optimize(),this.computeFirst(),this.computeFollow()},t.prototype.createTokenizer=function(t){var e=new r.Tokenizer(t);e.ignore("[ \t\r]+");for(var n=0;n<this.terminals.length;n++)e.addToken(this.terminals[n],this.innerExpr(this.terminals[n]));return e.EOF_TOKEN=this.EOF_TOKEN,e},t}();e.RuleSet=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(26),i=n(27),s=n(28),o=n(6),a=n(29),u=n(5),c=function(){function t(t){this.dbg=t,this.root=new r.NfaState,this.index=0,this.listId=1,this.dfaCache={},this.text="",this.lineNumbers=[],this.EOF_TOKEN={},this.IGNORE_TOKEN={},this.finished=!0}return t.prototype.addToken=function(t,e){this.expr=e,this.index=0;var n=this.parseAlternation();this.root.next.push(n.start),n.end.accept=t},t.prototype.ignore=function(t){this.addToken(this.IGNORE_TOKEN,t)},t.prototype.eof=function(){return this.index==this.expr.length},t.prototype.matchChar=function(t){return this.expr[this.index]==t&&(this.index++,!0)},t.prototype.peek=function(t){return this.expr[this.index]==t},t.prototype.parseChar=function(){return this.matchChar("\\")?this.matchChar("n")?"\n":this.matchChar("r")?"\r":this.matchChar("t")?"\t":this.matchChar("d")?o.DIGIT_CHAR:this.expr[this.index++]:this.matchChar(".")?o.ANY_CHAR:this.matchChar("$")?o.PRE_NEWLINE:this.matchChar("^")?o.POST_NEWLINE:this.expr[this.index++]},t.prototype.parseRange=function(){for(var t=!0,e=[];!this.eof()&&!this.peek("]");){this.matchChar("^")&&(t=!1);var n=this.parseChar(),s=n;this.matchChar("-")&&(s=this.parseChar()),n==o.DIGIT_CHAR&&(n="0",s="9"),e.push([n,s])}var u=new r.NfaState(new a.RangeMatcher(e,t));return new i.NFA(u,u)},t.prototype.parseBasic=function(){var t;if(this.matchChar("(")){if(t=this.parseAlternation(),!this.matchChar(")"))throw"Expected ')'"}else if(this.matchChar("[")){if(t=this.parseRange(),!this.matchChar("]"))throw"Expected ']'"}else{var e=new r.NfaState(new o.CharMatcher(this.parseChar()));t=new i.NFA(e,e)}return t},t.prototype.parseKleene=function(){var t=this.parseBasic();if(this.matchChar("+")){var e=new r.NfaState;t.end.next.push(e),e.next.push(t.start),t.end=e}else if(this.matchChar("*")){(e=new r.NfaState).next.push(t.start),t.end.next.push(e),t.start=e,t.end=e}else if(this.matchChar("?")){var n=new r.NfaState,i=new r.NfaState;n.next.push(t.start),n.next.push(i),t.end.next.push(i),t.start=n,t.end=i}return t},t.prototype.parseConcat=function(){for(var t=new r.NfaState,e=t;!(this.peek("|")||this.peek(")")||this.eof());){var n=this.parseKleene();e.next.push(n.start),e=n.end}return new i.NFA(t,e)},t.prototype.parseAlternation=function(){var t=new r.NfaState,e=new r.NfaState;do{var n=this.parseConcat();t.next.push(n.start),n.end.next.push(e)}while(this.matchChar("|"));return new i.NFA(t,e)},t.prototype.addState=function(t,e,n){if(n.lastList!=this.listId&&(void 0!==n.accept&&e.push(n.accept),n.lastList=this.listId,t.push(n),void 0===n.mchar))for(var r=0;r<n.next.length;r++)this.addState(t,e,n.next[r])},t.prototype.nextState=function(t,e){var n,r=[],i=[];for(this.listId++,n=0;n<t.nfaStates.length;n++){var a=t.nfaStates[n];void 0!==a.mchar&&(a.mchar.match(e)?this.addState(r,i,a.next[0]):e!=o.PRE_NEWLINE&&e!=o.POST_NEWLINE||this.addState(r,i,a))}r.sort((function(t,e){return t.id-e.id}));var u="";for(n=0;n<r.length;n++)u+=r[n].id+".";return void 0===this.dfaCache[u]&&((t=new s.DfaState).nfaStates=r,t.accepts=i,this.dfaCache[u]=t),this.dfaCache[u]},t.prototype.setText=function(t){this.text=t,this.lineNumbers.length=0,this.lineNumbers.push(0),this.finished=!1;for(var e=0;e<this.text.length;e++)"\n"==this.text[e]&&this.lineNumbers.push(e+1)},t.prototype.getLine=function(t){return this.text.substr(this.lineNumbers[t],this.lineNumbers[t+1]-this.lineNumbers[t])},t.prototype.nextTokenInternal=function(t,e){this.dbg;var n,r=0,i=null;void 0===this.rootDfa&&(this.rootDfa=new s.DfaState,this.addState(this.rootDfa.nfaStates,this.rootDfa.accepts,this.root));var a=this.rootDfa,c=this.lineNumbers[t]+e;if(c==this.text.length)return this.finished=!0,new u.Token(this.EOF_TOKEN,"!EOF",t,e);for(c>0&&(r=this.text[c-1]),n=c;n<this.text.length;n++){var p=this.text[n];if("\n"===p&&r!=o.PRE_NEWLINE?(p=o.PRE_NEWLINE,n--):"\n"!==r&&0!==r||(p=o.POST_NEWLINE,n--),"\n"===r&&t++,r=p,void 0===a.next[p]&&(a.next[p]=this.nextState(a,p)),(a=a.next[p]).accepts.length&&(i=new u.Token(a.accepts[0],this.text.substr(c,n-c+1),t,c-this.lineNumbers[t])),0===a.nfaStates.length)break}return i},t.prototype.nextToken=function(t,e){for(;;){var n=this.nextTokenInternal(t,e);if(null===n||n.id!==this.IGNORE_TOKEN)return n;t=n.location.line,e=n.location.position+n.text.length}},t}();e.Tokenizer=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(6),i=function(){function t(t){this.next=[],this.id=r.getNextStateId(),this.lastList=0,this.accept=void 0,this.mchar=t}return t.prototype.toString=function(){var t="\nState ["+this.id+"] ch="+this.mchar+"\n";void 0!==this.accept&&(t+="    Accept "+this.accept+"\n");for(var e=0;e<this.next.length;e++)t+="    ch="+this.next[e].mchar+" goto ["+this.next[e].id+"]\n";return t},t}();e.NfaState=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.start=t,this.end=e}return t.prototype.toString=function(){for(var t={},e=[this.start],n="";e.length>0;){var r=e.pop();if(!t[r]){t[r]=1;for(var i=0;i<r.next.length;i++)e.push(r.next[i]);n+=r.toString()}}return n},t}();e.NFA=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(6),i=function(){this.nfaStates=[],this.next={},this.accepts=[],this.id=r.getNextStateId()};e.DfaState=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.ranges=t,this.include=e}return t.prototype.match=function(t){for(var e=0;e<this.ranges.length;e++){var n=this.ranges[e];if(t>=n[0]&&t<=n[1])return this.include}return!this.include},t.prototype.toString=function(){var t="[";this.include||(t+="^");for(var e=0;e<this.ranges.length;e++)this.ranges[e][0]==this.ranges[e][1]?t+=this.ranges[e][0]:t+=this.ranges[e][0]+"-"+this.ranges[e][1];return t+"]"},t}();e.RangeMatcher=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=0,i=function(){function t(t,e,n){this.name=t,this.symbols=e,this.action=n,this.id=r++}return t.prototype.toString=function(){for(var t=this.name+":",e=0;e<this.symbols.length;e++)t+=" "+this.symbols[e];return t},t}();e.Rule=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.name=e,this.typeName=n,this.isArray=r,this.type=null}return t.prototype.accept=function(t){t.visitArgument(this)},t}();e.AstArgument=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.location=t}return t.prototype.accept=function(t){t.visitEndStatement(this)},t}();e.AstEndStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.location=t}return t.prototype.accept=function(t){t.visitNullStatement(this)},t}();e.AstNullStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.lhs=e,this.expr=n}return t.prototype.accept=function(t){t.visitAssignStatement(this)},t}();e.AstAssignStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.lhs=e,this.op=n,this.rhs=r}return t.prototype.accept=function(t){t.visitBinaryOp(this)},t}();e.AstBinaryOp=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.name=e,this.args=n}return t.prototype.accept=function(t){t.visitCallStatement(this)},t}();e.AstCallStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.exprList=e,this.statements=n}return t.prototype.accept=function(t){t.visitCaseStatement(this)},t}();e.AstCaseStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.name=e,this.expr=n}return t.prototype.accept=function(t){t.visitConstStatement(this)},t}();e.AstConstStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.what=e}return t.prototype.accept=function(t){t.visitExitStatement(this)},t}();e.AstExitStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.value=e}return t.prototype.accept=function(t){t.visitConstantExpr(this)},t}();e.AstConstantExpr=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.label=e}return t.prototype.accept=function(t){t.visitGosub(this)},t}();e.AstGosubStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.label=e}return t.prototype.accept=function(t){t.visitGotoStatement(this)},t}();e.AstGotoStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r,i){void 0===i&&(i=!1),this.location=t,this.promptExprOrfileNumber=e,this.printQuestionMark=n,this.identifiersOrReference=r,this.isLine=i}return t.prototype.accept=function(t){t.visitInputStatement(this)},t}();e.AstInputStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.label=e}return t.prototype.accept=function(t){t.visitLabel(this)},t}();e.AstLabel=r},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.name=n,i.typeName=r,i}return i(e,t),e.prototype.accept=function(t){t.visitTypeMember(this)},e}(n(2).TreeNode);e.AstTypeMember=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.identifiers=e}return t.prototype.accept=function(t){t.visitNextStatement(this)},t}();e.AstNextStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.data=e}return t.prototype.accept=function(t){t.visitDataStatement(this)},t}();e.AstDataStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r,i){this.location=t,this.identifier=e,this.startExpr=n,this.endExpr=r,this.stepExpr=i}return t.prototype.accept=function(t){t.visitForLoop(this)},t}();e.AstForLoop=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.expr=e,this.statements=n,this.elseStatements=r}return t.prototype.accept=function(t){t.visitIfStatement(this)},t}();e.AstIfStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.lhs=e,this.identifier=n}return t.prototype.accept=function(t){t.visitMemberDeref(this)},t}();e.AstMemberDeref=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.printItems=e,this.fileNumber=n}return t.prototype.accept=function(t){t.visitPrintStatement(this)},t}();e.AstPrintStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.exprList=e,this.terminator=n}return t.prototype.accept=function(t){t.visitPrintUsingStatement(this)},t}();e.AstPrintUsingStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.value=e}return t.prototype.accept=function(t){t.visitReturnStatement(this)},t}();e.AstReturnStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.expr=e,this.cases=n}return t.prototype.accept=function(t){t.visitSelectStatement(this)},t}();e.AstSelectStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r,i,s){this.location=t,this.name=e,this.args=n,this.statements=r,this.isFunction=i,this.isStatic=s}return t.prototype.accept=function(t){t.visitSubroutine(this)},t}();e.AstSubroutine=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.op=e,this.expr=n}return t.prototype.accept=function(t){t.visitUnaryOperator(this)},t}();e.AstUnaryOperator=r},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e,n,r){var i=t.call(this,e)||this;return i.expr=n,i.statements=r,i}return i(e,t),e.prototype.accept=function(t){t.visitWhileLoop(this)},e}(n(2).TreeNode);e.AstWhileLoop=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.lowerExpr=e,this.upperExpr=n}return t.prototype.accept=function(t){t.visitRange(this)},t}();e.AstRange=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.name=e,this.ranges=n,this.typeName=r,this.shared=!1}return t.prototype.accept=function(t){t.visitDimStatement(this)},t}();e.AstDimStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.subs=[e]}return t.prototype.accept=function(t){t.visitProgram(this)},t}();e.AstProgram=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.location=t,this.typeName=e}return t.prototype.accept=function(t){t.visitDefTypeStatement(this)},t}();e.AstDefTypeStatement=r},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(e,n){var r=t.call(this,e)||this;return r.label=n,r}return i(e,t),e.prototype.accept=function(t){t.visitRestoreStatement(this)},e}(n(2).TreeNode);e.AstRestoreStatement=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.name=e,this.members=n}return t.prototype.accept=function(t){t.visitUserType(this)},t}();e.AstUserType=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n){this.location=t,this.expr=e,this.parameters=n,this.type=null}return t.prototype.accept=function(t){t.visitArrayDeref(this)},t}();e.AstArrayDeref=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(13),i=n(14),s=n(7),o=n(66),a=n(0),u=n(8),c=n(9),p=n(70),h=n(71),l=function(){function t(){this.instructions=[],this.data=[],this.shared={},this.labels=[],this.labelMap={},this.loopStack=[],this.selectStack=[],this.functionNames={},this.lineMapping=[],this.lastLine=-1,this.callMap=new Map,this.getGotoLabel(":top")}return t.prototype.link=function(){for(var t=0;t<this.instructions.length;t++){var e=this.instructions[t];e.addrLabel?e.arg=this.labels[e.arg].codeOffset:e.dataLabel&&(e.arg=this.labels[e.arg].dataOffset)}},t.prototype.newLabel=function(t){var e=this.labels.length,n=t+"_"+e;return this.labels.push(new p.Label(n,this.instructions.length,this.data.length)),e},t.prototype.label=function(t){this.labels[t].codeOffset=this.instructions.length,this.labels[t].dataOffset=this.data.length},t.prototype.map=function(t){t.line!==this.lastLine&&(this.lastLine=t.line,this.lineMapping[this.instructions.length]=t)},t.prototype.getGotoLabel=function(t){var e;return t in this.labelMap?e=this.labelMap[t]:(e=this.newLabel(t),this.labelMap[t]=e),e},t.prototype.write=function(t,e){var n=o.Instructions[t](e);if(void 0===n)throw"Bad instruction: "+t;this.instructions.push(n)},t.prototype.visitProgram=function(t){for(var e=0;e<t.subs.length;e++)t.subs[e].accept(this);this.link()},t.prototype.visitDeclareFunction=function(t){this.functionNames[t.name]=1},t.prototype.visitSubroutine=function(t){var e=null;if(this.map(t.location),"_main"!=t.name){e=this.newLabel("skipsub"),this.write("JMP",e),this.label(this.getGotoLabel(t.name));for(var n=t.args.length-1;n>=0;n--)this.write("POPVAR",t.args[n].name)}t.statements.accept(this),t.isFunction&&this.write("PUSHVALUE",t.name),this.write("RET",null),null!==e?this.label(e):this.write("END",null)},t.prototype.visitCallStatement=function(t){this.map(t.location);for(var e=0;e<t.args.length;e++)t.args[e].accept(this);if(c.SystemSubroutines[t.name]){var n=c.SystemSubroutines[t.name];void 0!==n.args&&void 0!==n.minArgs&&this.write("PUSHCONST",t.args.length),this.write("SYSCALL",t.name)}else"PRINT"==t.name?(this.write("PUSHCONST",t.args.length),this.write("SYSCALL",t.name)):(this.write("CALL",this.getGotoLabel(t.name)),this.callMap.set(this.instructions.length-1,{name:t.name,location:t.location}))},t.prototype.visitArgument=function(t){},t.prototype.visitPrintUsingStatement=function(t){for(var e=0;e<t.exprList.length;e++)t.exprList[e].accept(this);this.write("PUSHCONST",t.terminator),this.write("PUSHCONST",t.exprList.length+1),this.write("SYSCALL","print_using")},t.prototype.visitPrintStatement=function(t){var e=!0;if(this.map(t.location),t.fileNumber){for(var n=0;n<t.printItems.length;n++)t.printItems[n].accept(this);return this.write("PUSHCONST",t.printItems.length),this.write("PUSHCONST",t.fileNumber),void this.write("SYSCALL","print_file")}for(n=0;n<t.printItems.length;n++)t.printItems[n].accept(this),t.printItems[n].type===r.AstPrintItem.TAB?this.write("SYSCALL","print_tab"):t.printItems[n].expr&&this.write("SYSCALL","print"),","==t.printItems[n].terminator?(this.write("SYSCALL","print_comma"),e=!1):e=";"!=t.printItems[n].terminator;e&&(this.write("PUSHCONST","\n"),this.write("SYSCALL","print"))},t.prototype.visitPrintItem=function(t){t.expr&&t.expr.accept(this)},t.prototype.visitInputStatement=function(t){if(this.map(t.location),t.promptExprOrfileNumber){if("string"==typeof t.promptExprOrfileNumber){var e=t.isLine;this.write("PUSHCONST",e?1:0);var n=t.identifiersOrReference;n.wantRef=!0,n.accept(this);var r=t.promptExprOrfileNumber;return this.write("PUSHCONST",r),void this.write("SYSCALL","INPUT")}t.promptExprOrfileNumber.accept(this),this.write("SYSCALL","print")}t.printQuestionMark?(this.write("PUSHCONST","? "),this.write("SYSCALL","print")):(this.write("PUSHCONST"," "),this.write("SYSCALL","print"));for(var i=t.identifiersOrReference,s=0;s<i.length;s++)this.write("PUSHREF",i[s]);this.write("PUSHCONST",i.length),this.write("SYSCALL","INPUT")},t.prototype.visitNullStatement=function(t){},t.prototype.visitEndStatement=function(t){this.map(t.location),this.write("END",null)},t.prototype.visitForLoop=function(t){this.map(t.location);var e=this.newLabel("for"),n=this.newLabel("next"),r=this.newLabel("end_for");this.loopStack.push(new h.LoopContext(t.identifier,e,n,r)),t.startExpr.accept(this),this.write("POPVAR",t.identifier),t.endExpr.accept(this),t.stepExpr.accept(this),this.label(e),this.write("PUSHVALUE",t.identifier),this.write("FORLOOP",r)},t.prototype.visitNextStatement=function(t){this.map(t.location);for(var e=0;e<t.identifiers.length;e++){var n=this.loopStack.pop();this.label(n.nextLabel),this.write("COPYTOP"),this.write("PUSHVALUE",n.counter),this.write("+"),this.write("POPVAL",n.counter),this.write("JMP",n.forLabel),this.label(n.endLabel)}},t.prototype.visitExitStatement=function(t){var e=this.loopStack[this.loopStack.length-1];e.counter&&(this.write("POP"),this.write("POP")),this.write("JMP",e.endLabel)},t.prototype.visitArrayDeref=function(t){if(this.map(t.location),t.expr instanceof s.AstVariableReference&&this.functionNames[t.expr.name])t.parameters.accept(this),this.write("CALL",this.getGotoLabel(t.expr.name));else if(t.expr instanceof s.AstVariableReference&&u.SystemFunctions[t.expr.name]){var e=u.SystemFunctions[t.expr.name];t.parameters.accept(this),e.minArgs<e.args.length&&this.write("PUSHCONST",t.parameters.length),t.expr.accept(this)}else t.parameters.accept(this),t.expr.accept(this),t.parameters.length>0&&this.write("ARRAY_DEREF",t.wantRef)},t.prototype.visitMemberDeref=function(t){this.map(t.location),t.lhs.accept(this),t.wantRef?this.write("MEMBER_DEREF",t.identifier):this.write("MEMBER_VALUE",t.identifier)},t.prototype.visitVariableReference=function(t){this.map(t.location),u.SystemFunctions[t.name]?this.write("SYSCALL",t.name):this.functionNames[t.name]?(this.write("CALL",this.getGotoLabel(t.name)),t.wantRef&&this.write("NEW",t.type.name)):t.wantRef||a.IsArrayType(t.type)?this.write("PUSHREF",t.name):this.write("PUSHVALUE",t.name)},t.prototype.visitRange=function(t){},t.prototype.visitDataStatement=function(t){for(var e=0;e<t.data.length;e++)this.data.push(t.data[e].value)},t.prototype.visitReturnStatement=function(t){this.map(t.location),this.write("RET")},t.prototype.visitRestoreStatement=function(t){this.map(t.location);var e=0;e=t.label?this.getGotoLabel(t.label):this.getGotoLabel(":top"),this.write("RESTORE",e)},t.prototype.visitConstStatement=function(t){this.shared[t.name]=!0,t.expr.accept(this),this.write("POPVAL",t.name)},t.prototype.visitDefTypeStatement=function(t){},t.prototype.visitDimStatement=function(t){var e;if(this.map(t.location),e=t.typeName?t.typeName:"INTEGER",t.shared&&(this.shared[t.name]=!0),t.ranges.length>0){for(var n=0;n<t.ranges.length;n++)t.ranges[n].lowerExpr.accept(this),t.ranges[n].upperExpr.accept(this);this.write("PUSHCONST",t.ranges.length),this.write("PUSHTYPE",e),this.write("SYSCALL","alloc_array"),this.write("POPVAR",t.name)}else this.write("PUSHTYPE",e),this.write("SYSCALL","alloc_scalar"),this.write("POPVAR",t.name)},t.prototype.visitDoStatement=function(t){this.map(t.location);var e=this.newLabel("do"),n=this.newLabel("loop");switch(this.label(e),this.loopStack.push(new h.LoopContext(null,null,null,n)),t.statements.accept(this),this.loopStack.pop(),t.type){case i.AstDoStatement.UNTIL:t.expr.accept(this),this.write("BZ",e);break;case i.AstDoStatement.WHILE_AT_END:t.expr.accept(this),this.write("BNZ",e);break;case i.AstDoStatement.INFINITE:this.write("JMP",e)}this.label(n)},t.prototype.visitWhileLoop=function(t){this.map(t.location);var e=this.newLabel("while"),n=this.newLabel("wend");this.label(e),t.expr.accept(this),this.write("BZ",n),this.loopStack.push(new h.LoopContext(null,null,null,n)),t.statements.accept(this),this.loopStack.pop(),this.write("JMP",e),this.label(n)},t.prototype.visitIfStatement=function(t){this.map(t.location);var e=this.newLabel("endif"),n=this.newLabel("else");t.expr.accept(this),this.write("BZ",n),t.statements.accept(this),this.write("JMP",e),this.label(n),t.elseStatements&&(t.elseStatements.accept(this),this.write("JMP",e)),this.label(e)},t.prototype.visitSelectStatement=function(t){this.map(t.location);var e=this.newLabel("end_select");this.selectStack.push(e),t.expr.accept(this);for(var n=0,r=t.cases;n<r.length;n++){r[n].accept(this)}this.label(e),this.write("POP"),this.selectStack.pop()},t.prototype.visitCaseStatement=function(t){if(this.map(t.location),t.exprList.length>0){for(var e=this.newLabel("case_okay"),n=this.newLabel("case_skip"),r=0;r<t.exprList.length;r++)this.write("COPYTOP"),t.exprList[r].accept(this),this.write("="),this.write("BNZ",e);this.write("JMP",n),this.label(e),t.statements.accept(this),this.write("JMP",this.selectStack[this.selectStack.length-1]),this.label(n)}else t.statements.accept(this)},t.prototype.visitTypeMember=function(t){},t.prototype.visitUserType=function(t){},t.prototype.visitGotoStatement=function(t){this.map(t.location);var e=this.getGotoLabel(t.label);this.write("JMP",e)},t.prototype.visitGosub=function(t){this.map(t.location);var e=this.getGotoLabel(t.label);this.write("GOSUB",e)},t.prototype.visitLabel=function(t){this.label(this.getGotoLabel(t.label))},t.prototype.visitAssignStatement=function(t){this.map(t.location),t.expr.accept(this),t.lhs instanceof s.AstVariableReference&&this.functionNames[t.lhs.name]?this.write("POPVAL",t.lhs.name):(t.lhs.accept(this),this.write("ASSIGN"))},t.prototype.visitBinaryOp=function(t){this.map(t.location),t.lhs.accept(this),t.rhs.accept(this),this.write(t.op),t.wantRef&&this.write("NEW",t.type.name)},t.prototype.visitUnaryOperator=function(t){this.map(t.location),t.expr.accept(this),this.write("UNARY_OP",t.op),t.wantRef&&this.write("NEW",t.type.name)},t.prototype.visitConstantExpr=function(t){this.map(t.location),this.write("PUSHCONST",t.value),t.wantRef&&this.write("NEW",t.type.name)},t.prototype.visitOpenStatement=function(t){this.map(t.location),t.expr.accept(this),"INPUT"==t.mode?this.write("PUSHCONST","1"):this.write("PUSHCONST","0"),this.write("PUSHCONST",t.fileNumber),this.write("SYSCALL","OPEN")},t}();e.CodeGenerator=l},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=n(8),o=n(9),a=n(15),u=n(67),c=n(68),p=n(4),h=n(69),l=n(3),f=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="forloop",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack[t.stack.length-1],r=t.stack[t.stack.length-2],i=t.stack[t.stack.length-3];r<0&&n<i||r>0&&n>i?(t.stack.pop(),t.stack.pop(),t.stack.pop(),t.pc=e):t.stack.pop()},e}(h.Instruction),d=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="copytop",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack[t.stack.length-1])},e}(h.Instruction),m=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="restore",n.dataLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){t.debug&&t.trace.printf("RESTORE to %s\n",e),t.dataPtr=e},e}(h.Instruction),y=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="popval",n}return i(e,t),e.prototype.execute=function(t,e){t.getVariable(e).value=t.stack.pop()},e}(h.Instruction),v=function(t){function e(){var e=t.call(this)||this;return e.name="pop",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.pop()},e}(h.Instruction),g=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="pushref",n}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.getVariable(e))},e}(h.Instruction),b=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="pushvalue",n}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.getVariable(e).value)},e}(h.Instruction),S=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="pushtype",n}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.types[e])},e}(h.Instruction),x=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="popvar",n}return i(e,t),e.prototype.execute=function(t,e){t.setVariable(e,t.stack.pop())},e}(h.Instruction),T=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="new",n}return i(e,t),e.prototype.execute=function(t,e){var n=t.types[e];t.stack.push(new p.ScalarVariable(n,n.copy(t.stack.pop())))},e}(h.Instruction),w=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="end",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.pc=t.instructions.length},e}(h.Instruction),_=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="unary_op",n}return i(e,t),e.prototype.execute=function(t,e){var n,r=t.stack.pop();"NOT"==e?n=Number(!r):"-"==e?n=-r:t.trace.printf("No such unary operator: %s\n",e),t.stack.push(n)},e}(h.Instruction),N=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="=",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack.pop()==t.stack.pop()?-1:0)},e}(h.Instruction),E=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="<",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r<n?-1:0)},e}(h.Instruction),R=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="<=",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r<=n?-1:0)},e}(h.Instruction),I=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name=">",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r>n?-1:0)},e}(h.Instruction),A=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name=">=",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r>=n?-1:0)},e}(h.Instruction),k=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="<>",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack.pop()!=t.stack.pop()?-1:0)},e}(h.Instruction),O=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="and",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack.pop()&t.stack.pop())},e}(h.Instruction),P=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="or",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack.pop()|t.stack.pop())},e}(h.Instruction),L=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="+",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r+n)},e}(h.Instruction),C=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="-",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r-n)},e}(h.Instruction),M=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="*",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(t.stack.pop()*t.stack.pop())},e}(h.Instruction),D=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="/",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r/n)},e}(h.Instruction),F=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="^",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(Math.pow(r,n))},e}(h.Instruction),j=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="mod",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();t.stack.push(r%n)},e}(h.Instruction),G=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="bz",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){t.stack.pop()||(t.pc=e)},e}(h.Instruction),U=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="bnz",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){0!==t.stack.pop()&&(t.pc=e)},e}(h.Instruction),B=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="jmp",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){t.pc=e},e}(h.Instruction),H=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="call",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){t.frame=new a.StackFrame(t.pc),t.callstack.push(t.frame),t.pc=e},e}(h.Instruction),V=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="gosub",n.addrLabel=!0,n}return i(e,t),e.prototype.execute=function(t,e){var n=t.frame.variables;t.frame=new a.StackFrame(t.pc),t.frame.variables=n,t.callstack.push(t.frame),t.pc=e},e}(h.Instruction),Y=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="ret",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){t.pc=t.callstack.pop().pc,t.frame=t.callstack[t.callstack.length-1]},e}(h.Instruction),W=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="pushconst",n}return i(e,t),e.prototype.execute=function(t,e){t.stack.push(e)},e}(h.Instruction),X=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="array_deref",n.numArgs=1,n}return i(e,t),e.prototype.execute=function(t,e){for(var n=t.stack.pop(),r=[],i=0;i<n.dimensions.length;i++)r.unshift(t.stack.pop());e?t.stack.push(n.access(r)):t.stack.push(n.access(r).value)},e}(h.Instruction),K=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="member_deref",n}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop()[e];t.stack.push(n)},e}(h.Instruction),z=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="member_value",n}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop()[e];t.stack.push(n.value)},e}(h.Instruction),$=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.name="assign",e.numArgs=0,e}return i(e,t),e.prototype.execute=function(t,e){var n=t.stack.pop(),r=t.stack.pop();n.value=n.type.copy(r)},e}(h.Instruction),Z=function(t){function e(e){var n=t.call(this)||this;return n.arg=e,n.name="syscall",n}return i(e,t),e.prototype.execute=function(t,e){var n,r,i,a,h;if(t.debug&&t.trace.printf("Execute syscall %s\n",e),"print_file"!==e)if("print"==e){for(h=0;h<1;h++){var f=t.stack.pop();t.debug&&t.trace.printf("printing %s\n",f),t.cons.print(""+f)}}else if("alloc_array"==e){r=t.stack.pop();var d=t.stack.pop(),m=[];for(h=0;h<d;h++){var y=t.stack.pop(),v=t.stack.pop();m.unshift(new c.Dimension(v,y))}n=new u.ArrayVariable(r,m),t.stack.push(n)}else if("print_comma"==e){for(i=t.cons.x,a="";++i%14;)a+=" ";t.cons.print(a)}else if("print_tab"==e){var g=t.stack.pop()-1;for(i=t.cons.x,a="";++i<g;)a+=" ";t.cons.print(a)}else"alloc_scalar"==e?(r=t.stack.pop(),n=new p.ScalarVariable(r,r.createInstance()),t.stack.push(n)):s.SystemFunctions[e]?s.SystemFunctions[e].action(t):o.SystemSubroutines[e]?o.SystemSubroutines[e].action(t):t.cons.print("Unknown syscall: "+e);else{for(var b=t.stack.pop(),S=t.stack.pop(),x="",T=0;T<S;++T)x=t.stack.pop()+x;l.setLineContent(b,x)}},e}(h.Instruction);e.Instructions={FORLOOP:function(t){return new f(t)},COPYTOP:function(){return new d},RESTORE:function(t){return new m(t)},POPVAL:function(t){return new y(t)},POP:function(){return new v},PUSHREF:function(t){return new g(t)},PUSHVALUE:function(t){return new b(t)},PUSHTYPE:function(t){return new S(t)},POPVAR:function(t){return new x(t)},NEW:function(t){return new T(t)},END:function(){return new w},UNARY_OP:function(t){return new _(t)},"=":function(){return new N},"<":function(){return new E},"<=":function(){return new R},">":function(){return new I},">=":function(){return new A},"<>":function(){return new k},AND:function(){return new O},OR:function(){return new P},"+":function(){return new L},"-":function(){return new C},"*":function(){return new M},"/":function(){return new D},"^":function(){return new F},MOD:function(){return new j},BZ:function(t){return new G(t)},BNZ:function(t){return new U(t)},JMP:function(t){return new B(t)},CALL:function(t){return new H(t)},GOSUB:function(t){return new V(t)},RET:function(){return new Y},PUSHCONST:function(t){return new W(t)},ARRAY_DEREF:function(t){return new X(t)},MEMBER_DEREF:function(t){return new K(t)},MEMBER_VALUE:function(t){return new z(t)},ASSIGN:function(){return new $},SYSCALL:function(t){return new Z(t)}}},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)}),s=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var o=n(4),a=function(t){function e(e,n){var r=t.call(this)||this;r.type=e,r.dimensions=n,r.values=[],r._values=[];for(var i=1,s=0;s<r.dimensions.length;s++)i*=r.dimensions[s].upper-r.dimensions[s].lower+1;for(var a=0;a<i;a++)r.values.push(new o.ScalarVariable(r.type,r.type.createInstance()));return r}return i(e,t),e.prototype.copy=function(){return this},e.prototype.getIndex=function(t){for(var e=1,n=0,r=this.dimensions.length-1;r>=0;r--)n+=(t[r]-this.dimensions[r].lower)*e,e*=this.dimensions[r].upper-this.dimensions[r].lower+1;return n},e.prototype.assign=function(t,e){var n=this.getIndex(t);this.values[n]=e},e.prototype.access=function(t){var e=this.getIndex(t);return this.values[e]},e}(s(n(16)).default);e.ArrayVariable=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e){this.lower=t,this.upper=e};e.Dimension=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(){}return t.prototype.toString=function(){return 0===this.numArgs?this.name:this.name+" "+this.arg},t}();e.Instruction=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e,n){this.name=t,this.codeOffset=e,this.dataOffset=n};e.Label=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e,n,r){this.counter=t,this.forLabel=e,this.nextLabel=n,this.endLabel=r};e.LoopContext=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(12),i=n(7),s=n(0),o=n(0),a=n(8),u=n(9),c=n(73),p=n(2),h=n(74),l=n(75),f=n(17),d=n(76),m=n(77),y=n(78),v=n(79),g=n(80),b=n(18),S=n(19),x=function(){function t(t){this.errors=t,this.declaredSubs={},this.scopes=[new c.TypeScope],this.shared=new c.TypeScope,this.labelsUsed=[],this.labelsDefined={},this.types={INTEGER:new d.IntegerType,SINGLE:new m.SingleType,DOUBLE:new y.DoubleType,STRING:new v.StringType,ANY:new g.AnyType,":NULL":new b.NullType},this.loopStack=[],this.declaredSubs._main=new r.AstDeclareFunction(new p.Location(0,0),"_main",[],!1),this.defaultType=this.types.SINGLE}return t.prototype.error=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=t.shift(),r="Error at "+n.location+": "+o.sprintf(t);this.errors.push(r),o.dbg.print(r+"\n")},t.prototype.removeSuffix=function(t){switch(t[t.length-1]){case"%":case"$":case"!":case"&":case"#":return t.substr(0,t.length-1);default:return t}},t.prototype.getTypeFromVariableName=function(t){var e=this.scopes[0].names[t];return void 0!==e?e:void 0!==(e=this.shared.names[t])?e:null!==(e=o.DeriveTypeNameFromVariable(t))?this.types[e]:this.defaultType},t.prototype.visitProgram=function(t){var e;for(e=0;e<t.subs.length;e++)t.subs[e].accept(this);for(e=0;e<this.labelsUsed.length;e++){var n=this.labelsUsed[e];void 0===this.labelsDefined[n.name]&&this.error(n.astNode,"Label %s is not defined",n.name)}for(var r in this.declaredSubs){var i=this.declaredSubs[r];!i.hasBody&&i.used&&this.error(i,"SUB or FUNCTION '%s' has no body",r)}},t.prototype.accept=function(t){for(var e=0;e<t.length;e++)t[e]&&t[e].accept(this)},t.prototype.visitDeclareFunction=function(t){void 0!==this.declaredSubs[t.name]&&this.error(t,"Subroutine %s is already declared on line %s",t.name,this.declaredSubs[t.name].location.line+1),this.declaredSubs[t.name]=t,this.accept(t.args),t.isFunction&&(t.type=this.getTypeFromVariableName(t.name))},t.prototype.visitSubroutine=function(t){var e=this,n=function(n){e.error(t,"Sub or function %s does not match declaration on line %s",t.name,n.location.line+1)};if(void 0===this.declaredSubs[t.name]){var i=new r.AstDeclareFunction(t.location,t.name,t.args,!1);this.visitDeclareFunction(i)}if(void 0===this.declaredSubs[t.name])this.error(t,"Subroutine %s is not declared",t.name);else{if((i=this.declaredSubs[t.name]).isFunction!=t.isFunction&&n(i),t.args.length!=i.args.length)n(i);else for(var s=0;s<t.args.length;s++)(t.args[s].typeName!=i.args[s].typeName&&"ANY"!=i.args[s].typeName||t.args[s].isArray!=i.args[s].isArray)&&n(i);i.hasBody=!0}this.scopes.unshift(new c.TypeScope);for(s=0;s<t.args.length;s++)t.args[s].accept(this),this.scopes[0].names[t.args[s].name]=t.args[s].type;for(s=0;s<t.statements.length;s++)t.statements[s]&&(void 0===t.statements[s].accept?o.dbg.printf("ERROR: Could not visit object of type %s\n",t.statements[s]):t.statements[s].accept(this));this.scopes.shift()},t.prototype.checkCallArguments=function(t,e){if(t.used=!0,t.args.length!=e.length)this.error(t,"Wrong number of arguments");else for(var n=0;n<e.length;n++)e[n].wantRef=!0,e[n].accept(this),s.AreTypesCompatible(e[n].type,t.args[n].type)||this.error(e[n],"Type mismatch in argument %d of call to %s. Expected %s but got %s",n+1,t.name,t.args[n].type.name,e[n].type.name)},t.prototype.visitCallStatement=function(t){if(void 0===u.SystemSubroutines[t.name]){var e=this.declaredSubs[t.name];void 0===e?this.error(t,"Call to undefined sub '%s'",t.name):this.checkCallArguments(e,t.args)}else for(var n=0;n<t.args.length;n++)t.args[n].wantRef=!0,t.args[n].accept(this)},t.prototype.visitArgument=function(t){var e;t.typeName?void 0===(e=this.types[t.typeName])&&(this.error(t,"Type %s is not defined",t.typeName),e=new f.UserType(t.typeName,{}),this.types[t.typeName]=e):e=this.getTypeFromVariableName(t.name),t.isArray&&(e=new S.ArrayType(e)),t.type=e},t.prototype.visitPrintStatement=function(t){for(var e=0,n=t.printItems;e<n.length;e++){n[e].accept(this)}},t.prototype.visitPrintUsingStatement=function(t){for(var e=0;e<t.exprList.length;e++)t.exprList[e].wantRef=!0,t.exprList[e].accept(this),0!==e||s.IsStringType(t.exprList[e].type)?e>0&&!s.IsStringType(t.exprList[e].type)&&!s.IsNumericType(t.exprList[e].type)&&this.error(t.exprList[e],"Type Mismatch Error"):this.error(t.exprList[e],"Format string must be STRING, not %s",t.exprList[e].type.name);0===t.exprList.length&&this.error(t,"PRINT USING requires at least one argument")},t.prototype.visitPrintItem=function(t){null!==t.expr&&(t.expr.accept(this),s.IsNumericType(t.expr.type)||s.IsStringType(t.expr.type)||this.error(t.expr,"Expected string or number, but got '%s'",t.expr.type.name))},t.prototype.visitInputStatement=function(t){if(t.promptExprOrfileNumber){if("string"==typeof t.promptExprOrfileNumber)return;t.promptExprOrfileNumber.accept(this),s.IsStringType(t.promptExprOrfileNumber.type)||this.error(t,"Prompt must be a string")}for(var e=0;e<t.identifiersOrReference.length;e++){var n=this.getTypeFromVariableName(t.identifiersOrReference[e]);s.IsNumericType(n)||s.IsStringType(n)||this.error(t,"Identifier '%s' should be string or numeric.",t.identifiersOrReference.type)}},t.prototype.visitNullStatement=function(t){},t.prototype.visitEndStatement=function(t){},t.prototype.visitForLoop=function(t){s.IsNumericType(this.getTypeFromVariableName(t.identifier))||this.error(t,"Loop counter must be a number"),t.startExpr.wantRef=!0,t.startExpr.accept(this),t.endExpr.accept(this),t.stepExpr.accept(this),s.IsNumericType(t.startExpr.type)&&s.IsNumericType(t.endExpr.type)&&s.IsNumericType(t.stepExpr.type)||this.error(t,"Loop expression must be a number."),this.loopStack.unshift(new l.CheckedLoopContext("FOR",t.identifier))},t.prototype.visitNextStatement=function(t){for(var e=0;e<t.identifiers.length;e++){if(0===this.loopStack.length){this.error(t,"NEXT without FOR");break}if("FOR"!==this.loopStack[0].type){this.error(t,"NEXT without FOR");break}t.identifiers[e]!=this.loopStack[0].counter&&this.error(t,"Mismatched loop counter '%s' in NEXT",t.identifiers[e]),this.loopStack.shift()}0===t.identifiers.length&&(0===this.loopStack.length?this.error(t,"NEXT without FOR"):this.loopStack.shift())},t.prototype.visitExitStatement=function(t){t.what&&"FOR"!=t.what&&"DO"!=t.what&&"WHILE"!=t.what&&this.error(t,"EXIT %s not supported",t.what),0===this.loopStack.length&&this.error(t,"EXIT without loop not supported"),t.what&&t.what!=this.loopStack[0].type&&this.error(t,"MISMATCHED EXIT. Expected: '%s'",this.loopStack[0].type)},t.prototype.visitArrayDeref=function(t){var e;if(t.expr.accept(this),t.expr instanceof i.AstVariableReference&&this.declaredSubs[t.expr.name]){var n=this.declaredSubs[t.expr.name];return n.isFunction||this.error(t,"Tried to call non-function '%s'",t.expr.name),this.checkCallArguments(n,t.parameters),void(t.type=n.type)}if(t.expr instanceof i.AstVariableReference&&void 0!==a.SystemFunctions[t.expr.name]){var r=a.SystemFunctions[t.expr.name];if(t.type=this.types[r.type],t.parameters.accept(this),t.parameters.length<r.minArgs||t.parameters.length>r.args.length)this.error(t,"Function '%s' called with wrong number of arguments",r.name);else for(e=0;e<t.parameters.length;e++)s.AreTypesCompatible(t.parameters[e].type,this.types[r.args[e]])||this.error(t,"Argument %d to '%s' function is of type '%s', but '%s' expected",e+1,r.name,t.parameters[e].type.name,r.args[e])}else{for(e=0;e<t.parameters.length;e++)t.parameters[e].accept(this),s.IsNumericType(t.parameters[e].type)||this.error(t.parameters[e],"Array subscript must be numeric type");s.IsArrayType(t.expr.type)?0===t.parameters.length?t.type=t.expr.type:t.type=t.expr.type.elementType:(this.error(t,"Subscript used on non-array '%s'",t.expr.name),t.type=this.types.INTEGER)}},t.prototype.visitMemberDeref=function(t){t.lhs.accept(this),o.IsUserType(t.lhs.type)?(t.type=t.lhs.type.members[t.identifier],void 0===t.type&&(this.error(t,"Type '%s' does not contain member '%s'",t.lhs.type.name,t.identifier),t.type=this.types.SINGLE)):(this.error(t,"Tried to dereference non-user-type '%s'",t.lhs.type.name),t.type=this.types.SINGLE)},t.prototype.visitVariableReference=function(t){var e;void 0!==a.SystemFunctions[t.name]?(e=a.SystemFunctions[t.name],t.type=this.types[e.type]):void 0!==this.declaredSubs[t.name]?(e=this.declaredSubs[t.name]).isFunction?t.type=e.type:(this.error(t,"SUB '%s' used as a function",e.name),t.type=this.types.SINGLE):t.type=this.getTypeFromVariableName(t.name)},t.prototype.visitRange=function(t){t.lowerExpr.accept(this),t.upperExpr.accept(this),s.IsNumericType(t.lowerExpr.type)&&s.IsNumericType(t.upperExpr.type)||this.error(t,"Expected a number.")},t.prototype.visitDataStatement=function(t){},t.prototype.visitReturnStatement=function(t){},t.prototype.visitRestoreStatement=function(t){t.label&&this.labelsUsed.push(new h.CheckedLabel(t.label,t))},t.prototype.visitConstStatement=function(t){t.name in this.shared.names&&this.error(t,"Redeclared variable '%s'",t.name),t.expr.accept(this),this.shared.names[t.name]=t.expr.type},t.prototype.visitDefTypeStatement=function(t){this.defaultType=this.types[t.typeName]},t.prototype.visitDimStatement=function(t){var e;t.typeName&&void 0===(e=this.types[t.typeName])&&this.error(t,"Type '%s' is not defined",t.typeName),e||(e=this.getTypeFromVariableName(t.name));for(var n=0;n<t.ranges.length;n++)t.ranges[n].accept(this);t.ranges.length&&(e=new S.ArrayType(e)),t.shared?this.shared.names[t.name]=e:this.scopes[0].names[t.name]=e},t.prototype.visitDoStatement=function(t){t.expr&&t.expr.accept(this),null===t.expr||s.IsNumericType(t.expr.type)||this.error(t,"Loop expression must be numeric"),this.loopStack.unshift(new l.CheckedLoopContext("DO",null)),t.statements.accept(this),this.loopStack.shift()},t.prototype.visitWhileLoop=function(t){t.expr.accept(this),s.IsNumericType(t.expr.type)||this.error(t,"Loop expression must be numeric"),this.loopStack.unshift(new l.CheckedLoopContext("WHILE",null)),t.statements.accept(this),this.loopStack.shift()},t.prototype.visitIfStatement=function(t){t.expr.accept(this),s.IsNumericType(t.expr.type)||this.error(t,"Expected numeric expression"),t.statements.accept(this),t.elseStatements&&t.elseStatements.accept(this)},t.prototype.visitSelectStatement=function(t){t.expr.accept(this),s.IsNumericType(t.expr.type)||s.IsStringType(t.expr.type)||this.error(t,"Select expression must be numeric or string");for(var e=0;e<t.cases.length;e++){var n=t.cases[e];n.accept(this);for(var r=0;r<n.exprList.length;r++)s.AreTypesCompatible(t.expr.type,n.exprList[r].type)||this.error(n,"CASE expression cannot be compared with SELECT")}},t.prototype.visitCaseStatement=function(t){t.exprList.accept(this),t.statements.accept(this)},t.prototype.visitTypeMember=function(t){var e;t.typeName&&void 0===(e=this.types[t.typeName])&&this.error(t,"Undefined type '%s'",t.typeName),void 0===e&&(e=this.getTypeFromVariableName(t.name)),t.type=e},t.prototype.visitUserType=function(t){void 0!==this.types[t.name]&&this.error(t,"Typename '%s' already defined",t.name);for(var e={},n=0;n<t.members.length;n++)t.members[n].accept(this),void 0!==e[t.members[n].name]&&this.error(t.members[n],"Type member '%s' already defined",t.members[n].name),e[t.members[n].name]=t.members[n].type;this.types[t.name]=new f.UserType(t.name,e)},t.prototype.visitGotoStatement=function(t){this.labelsUsed.push(new h.CheckedLabel(t.label,t))},t.prototype.visitGosub=function(t){this.labelsUsed.push(new h.CheckedLabel(t.label,t))},t.prototype.visitLabel=function(t){void 0!==this.labelsDefined[t.label]&&this.error(t,"Label '%s' is already defined",t.label),this.labelsDefined[t.label]=new h.CheckedLabel(t.label,t)},t.prototype.visitAssignStatement=function(t){t.lhs.wantRef=!0,t.lhs.accept(this),t.expr.accept(this),s.AreTypesCompatible(t.lhs.type,t.expr.type)||this.error(t,"Tried to assign type '%s' to type '%s'",t.expr.type.name,t.lhs.type.name)},t.prototype.visitBinaryOp=function(t){var e=t.op;t.lhs.accept(this),t.rhs.accept(this);var n=!1,r=t.lhs.type;s.AreTypesCompatible(t.lhs.type,t.rhs.type)||(n=!0),s.IsStringType(t.lhs.type)&&(n=n||"+"!=e&&"<"!=e&&">"!=e&&"<>"!=e&&"="!=e),o.IsUserType(t.lhs.type)&&(n=n||"="!=e),"="!=e&&"<>"!=e&&"<"!=e&&"<="!=e&&">="!=e||(r=this.types.INTEGER),s.IsArrayType(t.lhs.type)&&(n=!0),n&&this.error(t,"Incompatible types for '%s' operator: %s,%s",t.op,t.lhs.type.name,t.rhs.type.name),t.type=r},t.prototype.visitUnaryOperator=function(t){t.expr.accept(this),s.IsNumericType(t.expr.type)||this.error(t,"Incompatible type for '%s' operator",t.op),t.type=t.expr.type},t.prototype.visitConstantExpr=function(t){null===t.value?t.type=this.types[":NULL"]:t.value.constructor==String?t.type=this.types.STRING:t.type=this.types.SINGLE},t.prototype.visitOpenStatement=function(t){},t}();e.TypeChecker=x},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){this.names={}};e.TypeScope=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e){this.name=t,this.astNode=e};e.CheckedLabel=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(t,e){this.type=t,this.counter=e};e.CheckedLoopContext=r},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name="INTEGER",e}return i(e,t),e.prototype.createInstance=function(){return 0},e.prototype.copy=function(t){return(65535&Math.round(t+32768))-32768},e}(n(1).Type);e.IntegerType=s},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name="SINGLE",e}return i(e,t),e.prototype.createInstance=function(){return 0},e.prototype.copy=function(t){return t},e}(n(1).Type);e.SingleType=s},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name="DOUBLE",e}return i(e,t),e.prototype.createInstance=function(){return 0},e.prototype.copy=function(t){return t},e}(n(1).Type);e.DoubleType=s},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name="STRING",e}return i(e,t),e.prototype.createInstance=function(){return""},e.prototype.copy=function(t){return t},e}(n(1).Type);e.StringType=s},function(t,e,n){"use strict";var r,i=this&&this.__extends||(r=function(t,e){return(r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(t,e)},function(t,e){function n(){this.constructor=t}r(t,e),t.prototype=null===e?Object.create(e):(n.prototype=e.prototype,new n)});Object.defineProperty(e,"__esModule",{value:!0});var s=function(t){function e(){var e=t.call(this)||this;return e.name="ANY",e}return i(e,t),e}(n(1).Type);e.AnyType=s},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.text=""}return t.prototype.getText=function(){return this.text},t.prototype.resetText=function(){this.text=""},t.prototype.print=function(t){this.text+=t},t.prototype.printf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];function n(t,e){void 0===e&&(e=!1),t.sign=e?"":t.negative?"-":t.sign;var n=t.min-t.argument.length+1-t.sign.length,r=new Array(n<0?0:n).join(t.pad);return t.left?"0"==t.pad||e?t.sign+t.argument+r.replace(/0/g," "):t.sign+t.argument+r:"0"==t.pad||e?t.sign+r+t.argument:r+t.sign+t.argument}if(void 0!==arguments&&!(arguments.length<1)&&(t[0]instanceof Array&&(t=t[0]),"string"==typeof t[0]&&"undefined"!=typeof RegExp)){for(var r,i=t[0],s=new RegExp(/(%([%]|(\-)?(\+|\x20)?(0)?(\d+)?(\.(\d)?)?([bcdfosxX])))/g),o=[],a=[],u=0,c=0,p=0,h=0,l="",f=null;f=s.exec(i);)f[9]&&(u+=1),c=h,p=s.lastIndex-f[0].length,a[a.length]=i.substring(c,p),h=s.lastIndex,o[o.length]={match:f[0],left:!!f[3],sign:f[4]||"",pad:f[5]||" ",min:f[6]||0,precision:f[8],code:f[9]||"%",negative:parseInt(t[u],10)<0,argument:String(t[u])};if(a[a.length]=i.substring(h),!(t.length-1<u)){var d=null;for(d=0;d<o.length;d++)"%"==o[d].code?r="%":"b"==o[d].code?(o[d].argument=String(Math.abs(parseInt(o[d].argument,10)).toString(2)),r=n(o[d],!0)):"c"==o[d].code?(o[d].argument=String(String.fromCharCode(Math.abs(parseInt(o[d].argument,10)))),r=n(o[d],!0)):"d"==o[d].code?(o[d].argument=String(Math.abs(parseInt(o[d].argument,10))),r=n(o[d])):"f"==o[d].code?(o[d].argument=String(Math.abs(parseFloat(o[d].argument)).toFixed(o[d].precision?o[d].precision:6)),r=n(o[d])):"o"==o[d].code?(o[d].argument=String(Math.abs(parseInt(o[d].argument,10)).toString(8)),r=n(o[d])):"s"==o[d].code?(o[d].argument=o[d].argument.substring(0,o[d].precision?o[d].precision:o[d].argument.length),r=n(o[d],!0)):"x"==o[d].code?(o[d].argument=String(Math.abs(parseInt(o[d].argument,10)).toString(16)),r=n(o[d])):"X"==o[d].code?(o[d].argument=String(Math.abs(parseInt(o[d].argument,10)).toString(16)),r=n(o[d]).toUpperCase()):r=o[d].match,l+=a[d],l+=r;l+=a[d],this.print(l)}}},t}();e.DebugConsole=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e,n,r){this.location=t,this.expr=e,this.mode=n,this.fileNumber=r}return t.prototype.accept=function(t){t.visitOpenStatement(this)},t}();e.AstOpenStatement=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),i=n(84),s=n(15),o=n(4),a=function(){function t(t){this.cons=t,this.stack=[],this.pc=0,this.callstack=[],this.instructions=[],this.types={},this.shared={},this.trace=new i.TraceBuffer,this.dataPtr=0,this.data=[],this.asyncronous=!1,this.suspended=!1,this.interval=null,this.INTERVAL_MS=50,this.instructionsPerInterval=2048,this.lastRandomNumber=0,this.breakpoints=[],this.debug||(this.printStack=function(){},this.trace={printf:function(){}})}return t.prototype.isSuspended=function(){return this.suspended},t.prototype.reset=function(t){t&&(this.instructions=t.instructions,this.types=t.types,this.defaultType=t.defaultType,this.data=t.data,this.shared=t.shared),this.stack=[],this.callstack=[],this.callstack.push(new s.StackFrame(this.instructions.length)),this.frame=this.callstack[0],this.dataPtr=0,this.suspended=!1,this.interval&&(window.clearInterval(this.interval),this.interval=null),this.pc=0,t?this.cons.reset(t.testMode):this.cons.reset()},t.prototype.run=function(t,e){var n=this;if(this.breakpoints=t.getBreakpoints(),this.reset(t),this.asynchronous=!e,e)for(;this.pc<this.instructions.length;)this.runOneInstruction();else this.interval=window.setInterval((function(){n.runSome()}),this.INTERVAL_MS)},t.prototype.suspend=function(){this.suspended=!0,this.asynchronous&&window.clearInterval(this.interval)},t.prototype.resume=function(){var t=this;this.suspended=!1,this.asynchronous&&(this.interval=window.setInterval((function(){t.runSome()}),this.INTERVAL_MS))},t.prototype.runSome=function(){try{for(var t=0;t<this.instructionsPerInterval&&this.pc<this.instructions.length&&!this.suspended;t++){var e=this.instructions[this.pc++];if(this.debug&&this.trace.printf("Execute [%s] %s\n",this.pc-1,e),e.execute(this,e.arg),this.breakpoints.includes(this.pc))return void this.suspend()}}catch(t){}this.pc===this.instructions.length&&window.clearInterval(this.interval)},t.prototype.runOneInstruction=function(){var t=this.instructions[this.pc++];t.execute(this,t.arg)},t.prototype.setVariable=function(t,e){this.shared[t]?this.callstack[0].variables[t]=e:this.frame.variables[t]=e},t.prototype.getVariable=function(t){var e;if((e=this.shared[t]?this.callstack[0]:this.frame).variables[t])return e.variables[t];var n=r.DeriveTypeNameFromVariable(t),i=void 0;i=null===n?this.defaultType:this.types[n];var s=new o.ScalarVariable(i,i.createInstance());return e.variables[t]=s,s},t.prototype.printStack=function(){for(var t=0;t<this.stack.length;t++){var e=this.stack[t],n=e;"ScalarVariable"==n&&(n+=" "+e.value),this.trace.printf("stack[%s]: %s\n",t,n)}},t.prototype.pushScalar=function(t,e){this.stack.push(new o.ScalarVariable(this.types[e],t))},t}();e.VirtualMachine=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=n(0),i=function(){function t(){this.MAX_LINES=200,this.lines=[]}return t.prototype.toString=function(){return this.lines.join("")},t.prototype.printf=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var n=r.sprintf(t);this.lines.push(n),this.lines.length>this.MAX_LINES&&this.lines.shift(),r.dbg.printf("%s",n)},t}();e.TraceBuffer=i},function(t,e,n){"use strict";var r=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(e,"__esModule",{value:!0});var i=n(0),s=n(86),o=r(n(87)),a=function(){function t(t){var n=this;this.canvas=t,this.interval=0,this.cursorEnabled=!1,this.cursorShown=!1,this.cursorBackground=null,this.keyBuffer=[],this.hasFocus=!1,this.curX=0,this.curY=0,this.x=0,this.y=0,this.rows=0,this.cols=0,this.charWidth=0,this.charHeight=0,this.inputMode=!1,this.inputStr=0,this.inputPos=0,this.recorded="",this.Colours=["#000000","#000088","#008800","#008888","#880000","#880088","#884400","#888888","#444444","#0000ff","#00ff00","#00ffff","#ff0000","#ff00ff","#ffff00","#ffffff"],this.ScreenDimensions={1:{width:320,height:200},2:{width:640,height:200},3:{width:720,height:348},4:{width:640,height:400},7:{width:320,height:200},8:{width:640,height:200},9:{width:640,height:350},10:{width:640,height:350},11:{width:640,height:480},12:{width:640,height:480},13:{width:320,height:200}},this.canvas.width=640,this.canvas.height=400,this.canvas.tabIndex=0,this.ctx=this.canvas.getContext("2d"),this.ctx.setTransform(1,0,0,1,0,0),e.globalConsole=this,this.reset(!1);var r=this;window.onkeydown=function(t){n.hasFocus&&(n.onKeyDown(t),t.preventDefault())},t.onclick=function(e){t.style.borderColor="#008800",t.focus(),r.hasFocus=!0,e.stopPropagation()},window.onclick=function(e){n.hasFocus=!1,t.style.borderColor="rgba(14,99,156,0.8)"},t.style.borderWidth="1px",t.style.borderColor="#888888",t.style.borderStyle="solid",this.cls(),this.characterImageGenerator=new o.default(this.charWidth,this.charHeight)}return t.prototype.reset=function(t){void 0===t&&(t=!1),this.fgcolourNum=7,this.bgcolourNum=0,this.bgcolour=this.Colours[this.bgcolourNum],this.fgcolour=this.Colours[this.fgcolourNum],this.curX=0,this.curY=0,this.x=0,this.y=0,this.rows=25,this.cols=80,this.charWidth=8,this.charHeight=16,this.inputMode=!1,this.onInputDone=null,this.inputStr=0,this.inputPos=0,this.width=this.cols*this.charWidth,this.height=this.rows*this.charHeight,this.cls(),this.recording=t},t.prototype.record=function(t){this.recording&&(this.recorded+=t)},t.prototype.printError=function(t){this.recording||this.print(t)},t.prototype.setKeyBuffer=function(t){this.keyBuffer.length=0;for(var e=0;e<t.length;e++)this.keyBuffer.push(t.charCodeAt(e))},t.prototype.screen=function(t){var e=this.ScreenDimensions[t];return void 0!==e&&(this.cursor(!1),this.canvas.width=e.width,this.canvas.height=e.height,this.ctx.scale(this.width/e.width,this.height/e.height),this.width=e.width,this.height=e.height,!0)},t.prototype.line=function(t,e,n,r){this.ctx.strokeStyle=this.fgcolour,this.ctx.moveTo(t,e),this.ctx.lineTo(n,r),this.ctx.stroke(),this.curX=n,this.curY=r},t.prototype.lineTo=function(t,e){this.line(this.curX,this.curY,t,e)},t.prototype.circle=function(t,e,n,r,i,s,o,a){a&&(t=this.curX+t,e=this.curY+e),void 0===o&&(o=this.height/this.width*4/3),this.ctx.save(),this.ctx.translate(t,e),o>0?this.ctx.scale(1,o):this.ctx.scale(o,1),r&&(this.ctx.strokeStyle=this.Colours[r]),void 0===i&&(i=0),void 0===s&&(s=2*Math.PI),i=2*Math.PI-i,s=2*Math.PI-s,this.ctx.beginPath(),this.ctx.arc(0,0,n,i,s,!0),this.ctx.stroke(),this.ctx.restore()},t.prototype.get=function(t,e,n,r,i,s){var o;return i&&(t=this.curX+t,e=this.curY+e),s&&(t=this.curX+n,r=this.curY+r),t>n&&(o=t,t=n,n=o),e>r&&(o=e,e=r,r=o),this.ctx.getImageData(t,e,n-t,r-e)},t.prototype.put=function(t,e,n){this.ctx.putImageData(t,e,n)},t.prototype.paint=function(t,e,n,r,o){var a=new s.ImageManipulator(this.ctx.getImageData(0,0,this.width,this.height));i.dbg.printf("%s\n",a.get(10,10))},t.prototype.cls=function(){this.record("[CLS]"),this.cursor(!1),this.x=0,this.y=0,this.ctx.fillStyle=this.bgcolour,this.ctx.fillRect(0,0,this.width,this.height)},t.prototype.locate=function(t,e){this.record("[L"+t+","+e+"]"),this.cursor(!1),this.x=Math.floor(e)-1,this.y=Math.floor(t)-1},t.prototype.color=function(t,e){void 0===t&&(t=this.fgcolourNum),void 0===e&&(e=this.bgcolourNum),this.record("[C"+t),this.record(","+e),this.record("]\n"),this.fgcolourNum=t,this.fgcolour=this.Colours[t],this.bgcolourNum=e,this.bgcolour=this.Colours[e]},t.prototype.scroll=function(){this.cursor(!1),this.ctx.drawImage(this.canvas,0,this.charHeight,this.width,this.height-this.charHeight,0,0,this.width,this.height-this.charHeight),this.ctx.fillStyle=this.bgcolour,this.ctx.fillRect(0,this.height-this.charHeight,this.width,this.charHeight),this.y-=1},t.prototype.input=function(t){if(this.recording){for(var e="";this.keyBuffer.length>0;)e+=String.fromCharCode(this.keyBuffer.shift());t(e)}else this.enableCursor(!0),this.onInputDone=t,this.inputMode=!0,this.inputStr="",this.inputPos=0},t.prototype.backup=function(t){for(this.cursor(!1),this.x-=t;this.x<0;)this.y-=1,this.x+=this.cols;this.y<0&&(this.y=0)},t.prototype.onKeyDown=function(t){if(this.inputMode){if(this.inputStr.length>0&&8==t.keyCode&&(this.inputStr=this.inputStr.substr(0,this.inputStr.length-1),this.backup(1),this.print(" "),this.backup(1)),13===t.keyCode&&(this.inputMode=!1,this.print("\n"),this.enableCursor(!1),this.onInputDone(this.inputStr)),t.keyCode>=32&&t.keyCode<=126){var e=String.fromCharCode(t.keyCode);this.inputStr+=e,this.inputPos+=1,this.print(e)}}else{var n={37:75,38:72,39:77,40:80};t.keyCode in n?(this.keyBuffer.push(0),this.keyBuffer.push(n[t.keyCode])):this.keyBuffer.push(t.keyCode)}},t.prototype.getKeyFromBuffer=function(){return this.keyBuffer.length>0?this.keyBuffer.shift():-1},t.prototype.enableCursor=function(t){var e=this;t&&!this.cursorEnabled?(this.interval=window.setInterval((function(){e.toggleCursor()}),500),this.cursor(!0)):(window.clearInterval(this.interval),this.cursor(!1)),this.cursorEnabled=t},t.prototype.toggleCursor=function(){this.cursor(!this.cursorShown)},t.prototype.cursor=function(t){var e=this.ctx;t!=this.cursorShown&&(e.save(),t?(this.ctx.fillStyle=this.fgcolour,this.ctx.fillRect(this.x*this.charWidth,this.y*this.charHeight+this.charHeight-2,this.charWidth,2)):(this.ctx.fillStyle=this.bgcolour,this.ctx.fillRect(this.x*this.charWidth,this.y*this.charHeight+this.charHeight-2,this.charWidth,2)),e.restore(),this.cursorShown=t)},t.prototype.newline=function(){this.x=0,this.y+=1},t.prototype.print=function(t){this.recording&&(this.recorded+=t),this.cursor(!1);var e=this.bgcolour,n=this.fgcolour,r=this.ctx;r.fillStyle=e,r.font="16px Consolas",r.textBaseline="middle",r.textAlign="center";for(var i=this.characterImageGenerator,s=0;s<t.length;s++)this.y==this.rows&&this.scroll(),"\n"==t[s]?this.newline():(r.fillStyle=e,r.drawImage(i.toImage(" ",n,e),this.x*this.charWidth,this.y*this.charHeight),r.fillStyle=n,r.drawImage(i.toImage(t[s],n,e),this.x*this.charWidth,this.y*this.charHeight),r.fillStyle=e,this.x+=1,this.x==this.cols&&this.newline())},t}();e._Console=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t){this.image=t}return t.prototype.get=function(t,e){return this.image.data[this.image.width*e+t]},t.prototype.put=function(t,e,n){this.image.data[this.image.width*e+t]=n},t}();e.ImageManipulator=r},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var r=function(){function t(t,e){this.charWidth=t,this.charHeight=e,this.canvas=document.createElement("canvas");var n=this.canvas;n.style.position="absolute",n.style.top="-9999px",n.style.left="-9999px",n.style.fontFamily="16px Consolas",n.width=t,n.height=e,n.tabIndex=0,this.context=n.getContext("2d");var r=this.context;r.setTransform(1,0,0,1,0,0),r.font="16px Consolas",r.textBaseline="middle",r.textAlign="center"}return t.prototype.toImage=function(t,e,n){var r=this.context,i=this.charWidth,s=this.charHeight;return" "===t?(r.fillStyle=n,r.fillRect(0,0,i,s),this.canvas):(r.fillStyle=e,r.fillText(t,.5*i,.5*s),this.canvas)},t}();e.default=r}])}));
//# sourceMappingURL=QuickBASIC.js.map